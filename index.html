<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ğŸ  å®¶åº­ç‰©å“ç®¡ç†ç³»ç»Ÿ</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { padding: 16px; background: #f9f9f9; color: #333; line-height: 1.6; }
    h1 { text-align: center; margin: 16px 0; font-size: 24px; }
    .tab-bar { display: flex; margin: 16px 0; gap: 8px; }
    .tab { flex: 1; padding: 12px; background: #e0e0e0; text-align: center; border-radius: 8px; cursor: pointer; }
    .tab.active { background: #4A90E2; color: white; }
    .panel { display: none; }
    #managePanel { display: block; }
    input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    label { display: block; font-weight: bold; margin-top: 12px; color: #444; }
    input[type="number"] { 
      -moz-appearance: textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    button { background: #4A90E2; color: white; border: none; cursor: pointer; }
    button.secondary { background: #666; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #itemsList { margin-top: 20px; }
    .item { background: white; padding: 16px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .location-path { color: #555; font-size: 14px; margin: 4px 0; }
    img { max-width: 100%; height: auto; margin-top: 8px; border-radius: 4px; }
    .qr-content { margin-top: 8px; padding: 8px; background: #f0f8ff; border-left: 3px solid #4A90E2; }
    #storageWarning { background: #fff8e1; padding: 10px; border-radius: 6px; margin: 10px 0; display: none; color: #e65100; }

    /* è‡ªå®šä¹‰ modal */
    #customModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    #modalContent {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 300px;
      text-align: center;
    }
    #modalTitle { font-weight: bold; margin-bottom: 12px; }
    #modalInput { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    .modal-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .modal-buttons button { flex: 1; padding: 8px; font-size: 14px; }

    canvas { display: none; }
    #photoUploadArea {
      display: block;
      text-align: center;
      padding: 20px;
      border: 2px dashed #ccc;
      cursor: pointer;
      margin: 15px 0;
      border-radius: 8px;
      background: #fafafa;
    }
    .quantity-badge {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 6px;
    }
  </style>
</head>
<body>

<h1>ğŸ  å®¶åº­ç‰©å“ç®¡ç†ç³»ç»Ÿ</h1>

<div class="tab-bar">
  <div class="tab active" data-tab="manage">ğŸ“¦ ç‰©å“ç®¡ç†</div>
  <div class="tab" data-tab="stats">ğŸ“Š ç»Ÿè®¡</div>
</div>

<!-- ç®¡ç†é¢æ¿ -->
<div id="managePanel" class="panel">
  <div id="storageWarning"></div>

  <label for="itemName">ç‰©å“åç§°ï¼ˆå¿…å¡«ï¼‰</label>
  <input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šèºä¸åˆ€ã€åˆ›å¯è´´" />

  <label for="itemQuantity">æ•°é‡ï¼ˆä¸ªï¼‰</label>
  <input 
    type="number" 
    inputmode="numeric"
    id="itemQuantity" 
    min="1" 
    value="1" 
    placeholder="ä¾‹å¦‚ï¼š1ã€5ã€100"
  />

  <label for="itemCategory">åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
  <input type="text" id="itemCategory" placeholder="å¦‚ï¼šå·¥å…·ã€è¯å“ã€æ–‡å…·" list="categoryList" />
  <datalist id="categoryList"></datalist>

  <label for="itemRoom">æ‰€åœ¨æˆ¿é—´ï¼ˆå¿…å¡«ï¼‰</label>
  <select id="itemRoom">
    <option value="">è¯·é€‰æ‹©æˆ¿é—´</option>
  </select>
  <button type="button" onclick="showAddModal('room')" style="margin-top:0;">â• æ–°å¢æˆ¿é—´</button>

  <label for="itemContainer">å®¹å™¨ï¼ˆå¯é€‰ï¼‰</label>
  <input type="text" id="itemContainer" placeholder="å¦‚ï¼šå·¥å…·ç®±ã€è¯ç›’" list="containerList" />
  <datalist id="containerList"></datalist>
  <button type="button" onclick="showAddModal('container')" style="margin-top:0;">â• æ–°å¢å®¹å™¨</button>

  <label for="itemShelf">å±‚/æ ¼ï¼ˆå¯é€‰ï¼‰</label>
  <input type="text" id="itemShelf" placeholder="å¦‚ï¼šä¸Šå±‚ã€ç¬¬ä¸€æ ¼" list="shelfList" />
  <datalist id="shelfList"></datalist>

  <label for="itemLocation">å…·ä½“ä½ç½®æè¿°ï¼ˆå¯é€‰ï¼‰</label>
  <textarea id="itemLocation" placeholder="ä¾‹å¦‚ï¼šåºŠå¤´æŸœç¬¬äºŒæŠ½å±‰" rows="2"></textarea>

  <label for="itemImage" id="photoUploadArea">
    ğŸ‘† ç‚¹å‡»é€‰æ‹©ç…§ç‰‡æˆ–æ‹ç…§
  </label>
  <input type="file" id="itemImage" accept="image/*" style="display:none;" />

  <label for="itemQrCode" style="display:block; text-align:center; padding:12px; background:#f0f8ff; border:1px dashed #4A90E2; border-radius:6px; margin:10px 0; cursor:pointer;">
    ğŸ·ï¸ ç‚¹å‡»ä¸Šä¼ äºŒç»´ç å›¾ç‰‡ï¼ˆè‡ªåŠ¨è¯†åˆ«å†…å®¹ï¼‰
  </label>
  <input type="file" id="itemQrCode" accept="image/*" style="display:none;" />

  <input type="hidden" id="editId" value="" />
  <button id="saveBtn">â• æ·»åŠ ç‰©å“</button>

  <hr style="margin:20px 0;" />
  <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ç‰©å“åç§°/ä½ç½®/äºŒç»´ç " />
  <div id="itemsList"></div>
  <p style="text-align:right; margin-top:10px; color:#666;">å…± <span id="totalItems">0</span> é¡¹ | æ€»è®¡ <span id="totalQuantity">0</span> ä¸ª</p>

  <div style="margin-top:20px; display:flex; gap:10px;">
    <button id="exportBtn" style="flex:1;">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
    <button id="importBtn" style="flex:1; background:#FF9800;">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
    <button id="clearDataBtn" style="flex:1; background:#f44336;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
  </div>
</div>

<!-- ç»Ÿè®¡é¢æ¿ -->
<div id="statsPanel" class="panel">
  <canvas id="roomChart" height="200"></canvas>
  <canvas id="categoryChart" height="200"></canvas>
  <canvas id="containerChart" height="200"></canvas>
</div>

<!-- è‡ªå®šä¹‰ Modal -->
<div id="customModal">
  <div id="modalContent">
    <div id="modalTitle">è¯·è¾“å…¥åç§°</div>
    <input type="text" id="modalInput" placeholder="ä¾‹å¦‚ï¼šä¹¦æˆ¿" maxlength="30" />
    <div class="modal-buttons">
      <button onclick="handleModalCancel()">å–æ¶ˆ</button>
      <button onclick="handleModalConfirm()" style="background:#4CAF50;">ç¡®å®š</button>
    </div>
  </div>
</div>

<canvas id="qrCanvas" style="display:none;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
let items = [];
let recentRooms = ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];
let recentContainers = ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];
let recentShelves = ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];
let currentModalType = '';

// ===== Modal æ§åˆ¶ =====
function showAddModal(type) {
  currentModalType = type;
  document.getElementById('modalTitle').textContent = type === 'room' ? 'æ–°å¢æˆ¿é—´' : 'æ–°å¢å®¹å™¨';
  document.getElementById('modalInput').value = '';
  document.getElementById('customModal').style.display = 'flex';
  document.getElementById('modalInput').focus();
}
function handleModalCancel() {
  document.getElementById('customModal').style.display = 'none';
  currentModalType = '';
}
function handleModalConfirm() {
  const value = document.getElementById('modalInput').value.trim();
  if (!value) {
    alert('åç§°ä¸èƒ½ä¸ºç©º');
    return;
  }
  let changed = false;
  if (currentModalType === 'room') {
    if (!recentRooms.includes(value)) {
      recentRooms.unshift(value);
      recentRooms = recentRooms.slice(0, 20); // é™åˆ¶æœ€å¤š20ä¸ª
      changed = true;
    }
  } else if (currentModalType === 'container') {
    if (!recentContainers.includes(value)) {
      recentContainers.unshift(value);
      recentContainers = recentContainers.slice(0, 20);
      changed = true;
    }
  }
  if (changed) {
    saveData();           // ä¿å­˜åˆ° localStorage
    renderFormOptions();  // âœ… å…³é”®ï¼šç«‹å³åˆ·æ–°ä¸‹æ‹‰æ¡†å’Œ datalist
  }
  handleModalCancel();
}
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('customModal').style.display === 'flex') {
    handleModalCancel();
  }
});
document.getElementById('customModal').addEventListener('click', (e) => {
  if (e.target.id === 'customModal') handleModalCancel();
});

// ===== æ ¸å¿ƒé€»è¾‘ =====
document.addEventListener('DOMContentLoaded', () => {

  function isDataTooLarge(dataToSave, maxSizeBytes = 4_700_000) {
    try {
      const jsonString = JSON.stringify(dataToSave);
      const byteLength = new TextEncoder().encode(jsonString).length;
      return byteLength > maxSizeBytes;
    } catch (e) {
      return true;
    }
  }

  function saveData() {
    try {
      const dataToSave = { items, recentRooms, recentContainers, recentShelves };
      if (isDataTooLarge(dataToSave)) {
        alert('âš ï¸ æ•°æ®è¿‡å¤§ï¼ˆè¶…è¿‡ 4.7MBï¼‰ï¼\nè¯·åˆ é™¤éƒ¨åˆ†å¸¦å›¾ç‰©å“åå†ä¿å­˜ã€‚');
        return false;
      }
      localStorage.setItem('homeItems_v5', JSON.stringify(items));
      localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
      localStorage.setItem('recentContainers', JSON.stringify(recentContainers));
      localStorage.setItem('recentShelves', JSON.stringify(recentShelves));
      renderFormOptions();
      renderItems();
      renderStats();
      updateStorageWarning();
      return true;
    } catch (err) {
      if (err.name === 'QuotaExceededError') {
        alert('âš ï¸ æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ï¼');
      } else {
        alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + (err.message || err));
      }
      return false;
    }
  }

  function updateStorageWarning() {
    try {
      const dataToSave = { items, recentRooms, recentContainers, recentShelves };
      const jsonString = JSON.stringify(dataToSave);
      const byteLength = new TextEncoder().encode(jsonString).length;
      const mb = (byteLength / 1024 / 1024).toFixed(2);
      const warningEl = document.getElementById('storageWarning');
      if (byteLength > 4_000_000) {
        warningEl.innerHTML = `ğŸ’¡ å½“å‰æ•°æ®å¤§å°çº¦ ${mb} MB`;
        warningEl.style.display = 'block';
      } else {
        warningEl.style.display = 'none';
      }
    } catch (e) {
      document.getElementById('storageWarning').style.display = 'none';
    }
  }

  function clearAllData() {
    if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰ç‰©å“å’Œè®¾ç½®ï¼\n\nè¯·ç¡®ä¿å·²å…ˆå¯¼å‡ºå¤‡ä»½ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
    items = []; 
    recentRooms = ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];
    recentContainers = ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];
    recentShelves = ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];
    localStorage.removeItem('homeItems_v5');
    localStorage.removeItem('recentRooms');
    localStorage.removeItem('recentContainers');
    localStorage.removeItem('recentShelves');
    renderFormOptions(); 
    renderItems(); 
    updateStorageWarning();
    alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
  }

  function safeImportData(data) {
    try {
      items = data.items || [];
      recentRooms = data.recentRooms || recentRooms;
      recentContainers = data.recentContainers || recentContainers;
      recentShelves = data.recentShelves || recentShelves;
      if (!saveData()) throw new Error('æ•°æ®è¿‡å¤§ï¼Œæ— æ³•ä¿å­˜');
      alert('âœ… å®‰å…¨å¯¼å…¥æˆåŠŸï¼');
    } catch (err) {
      items = []; 
      recentRooms = ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];
      recentContainers = ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];
      recentShelves = ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];
      alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + err.message);
    }
  }

  async function compressImage(file, maxWidth = 400, quality = 0.65) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.src = url;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        let { width, height } = img;
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        canvas.toBlob(blob => {
          URL.revokeObjectURL(url);
          if (!blob) return reject(new Error('Canvas toBlob å¤±è´¥'));
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error('è¯»å–å‹ç¼©å›¾åƒå¤±è´¥'));
          reader.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        reject(new Error('åŠ è½½å›¾åƒå¤±è´¥'));
      };
    });
  }

  async function decodeQRFromFile(file) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.src = url;
      img.onload = () => {
        const MAX_DIMENSION = 1500;
        let { width, height } = img;
        if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
          const scale = Math.min(MAX_DIMENSION / width, MAX_DIMENSION / height);
          width = Math.floor(width * scale);
          height = Math.floor(height * scale);
        }
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        const imageData = ctx.getImageData(0, 0, width, height);
        URL.revokeObjectURL(url);
        try {
          const code = jsQR(imageData.data, width, height);
          if (code) resolve(code.data.trim());
          else reject(new Error('æœªæ£€æµ‹åˆ°æœ‰æ•ˆäºŒç»´ç '));
        } catch (err) {
          reject(new Error('äºŒç»´ç è§£æå¤±è´¥ï¼š' + (err.message || err)));
        }
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
      };
    });
  }

  function uuid() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  function getLocationPath(item) {
    let path = item.room;
    if (item.container) path += ` > ${item.container}`;
    if (item.shelf_or_compartment) path += ` > ${item.shelf_or_compartment}`;
    return path;
  }

  function renderFormOptions() {
    const itemRoom = document.getElementById('itemRoom');
    const containerList = document.getElementById('containerList');
    const categoryList = document.getElementById('categoryList');
    const shelfList = document.getElementById('shelfList');

    itemRoom.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ¿é—´</option>';
    recentRooms.forEach(room => {
      const opt = document.createElement('option');
      opt.value = room;
      opt.textContent = room;
      itemRoom.appendChild(opt);
    });

    containerList.innerHTML = '';
    recentContainers.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      containerList.appendChild(opt);
    });

    categoryList.innerHTML = '';
    [...new Set(items.map(i => i.category).filter(Boolean))].forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      categoryList.appendChild(opt);
    });

    shelfList.innerHTML = '';
    recentShelves.forEach(shelf => {
      const opt = document.createElement('option');
      opt.value = shelf;
      shelfList.appendChild(opt);
    });
  }

  function renderItems() {
    const searchInput = document.getElementById('searchInput');
    const itemsList = document.getElementById('itemsList');
    const term = searchInput.value.trim().toLowerCase();
    const filtered = items.filter(item =>
      item.name.toLowerCase().includes(term) ||
      getLocationPath(item).toLowerCase().includes(term) ||
      (item.specific_location && item.specific_location.toLowerCase().includes(term)) ||
      (item.qr_code && item.qr_code.toLowerCase().includes(term))
    );

    itemsList.innerHTML = filtered.length === 0
      ? '<p style="text-align:center;color:#888;">æš‚æ— ç‰©å“</p>'
      : filtered.map(item => {
          const qtyDisplay = item.quantity > 1 ? `<span class="quantity-badge">Ã—${item.quantity}</span>` : '';
          let qrDisplay = '';
          if (item.qr_code) {
            const isUrl = /^https?:\/\//.test(item.qr_code);
            qrDisplay = `
              <div class="qr-content">
                <strong>ğŸ”— äºŒç»´ç å†…å®¹ï¼š</strong>
                ${isUrl 
                  ? `<a href="${item.qr_code}" target="_blank" rel="noopener">${item.qr_code}</a>`
                  : `<span>${item.qr_code}</span>`
                }
              </div>
            `;
          }

          return `
            <div class="item">
              <strong>${item.name}</strong> ${qtyDisplay}
              ${item.category ? `<br><small>ğŸ“‚ ${item.category}</small>` : ''}
              <div class="location-path">${getLocationPath(item)}</div>
              ${item.specific_location ? `<div>${item.specific_location}</div>` : ''}
              ${item.image ? `<img src="${item.image}" alt="${item.name}" style="max-height:100px;">` : ''}
              ${qrDisplay}
              <div style="margin-top:10px;">
                <button class="secondary" style="padding:6px 10px;font-size:14px;" onclick="editItem('${item.id}')">âœï¸ ç¼–è¾‘</button>
                <button class="secondary" style="padding:6px 10px;font-size:14px;" onclick="deleteItem('${item.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
              </div>
            </div>
          `;
        }).join('');

    const totalQty = items.reduce((sum, item) => sum + (item.quantity || 1), 0);
    document.getElementById('totalItems').textContent = items.length;
    document.getElementById('totalQuantity').textContent = totalQty;
  }

  window.editItem = function(id) {
    const item = items.find(i => i.id === id);
    if (!item) return;
    document.getElementById('editId').value = item.id;
    document.getElementById('itemName').value = item.name;
    document.getElementById('itemQuantity').value = item.quantity || 1;
    document.getElementById('itemCategory').value = item.category || '';
    document.getElementById('itemRoom').value = item.room;
    document.getElementById('itemContainer').value = item.container || '';
    document.getElementById('itemShelf').value = item.shelf_or_compartment || '';
    document.getElementById('itemLocation').value = item.specific_location || '';
    document.getElementById('saveBtn').textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
    window.scrollTo(0, 0);
  };

  window.deleteItem = function(id) {
    if (confirm('ç¡®å®šåˆ é™¤æ­¤ç‰©å“ï¼Ÿ')) {
      items = items.filter(item => item.id !== id);
      saveData();
    }
  };

  document.getElementById('saveBtn').addEventListener('click', async () => {
    const itemName = document.getElementById('itemName');
    const itemRoom = document.getElementById('itemRoom');
    const name = itemName.value.trim();
    const room = itemRoom.value.trim();

    // âœ… å¼ºåŒ–æ•°é‡æ ¡éªŒ
    let quantityStr = document.getElementById('itemQuantity').value.trim();
    let quantity = 1;
    if (quantityStr !== '') {
      const parsed = parseInt(quantityStr, 10);
      if (isNaN(parsed) || parsed < 1) {
        alert('æ•°é‡å¿…é¡»æ˜¯å¤§äºç­‰äº1çš„æ•´æ•°');
        return;
      }
      quantity = parsed;
    }

    if (!name || !room) {
      alert('è¯·å¡«å†™ç‰©å“åç§°å’Œæˆ¿é—´');
      return;
    }

    const MAX_QR_SIZE = 5 * 1024 * 1024;
    const itemQrCode = document.getElementById('itemQrCode');
    if (itemQrCode.files[0] && itemQrCode.files[0].size > MAX_QR_SIZE) {
      alert('ğŸ·ï¸ äºŒç»´ç å›¾ç‰‡è¿‡å¤§ï¼ˆè¶…è¿‡ 5MBï¼‰');
      return;
    }

    const originalText = document.getElementById('saveBtn').textContent;
    document.getElementById('saveBtn').disabled = true;
    document.getElementById('saveBtn').textContent = 'â³ ä¿å­˜ä¸­...';

    try {
      let imageBase64 = '';
      let qrContent = '';

      const itemImage = document.getElementById('itemImage');
      if (itemImage.files[0]) {
        imageBase64 = await compressImage(itemImage.files[0]);
      }
      if (itemQrCode.files[0]) {
        qrContent = await decodeQRFromFile(itemQrCode.files[0]);
      }

      const newItem = {
        id: document.getElementById('editId').value || uuid(),
        name,
        quantity,
        category: document.getElementById('itemCategory').value.trim() || null,
        room,
        container: document.getElementById('itemContainer').value.trim() || null,
        shelf_or_compartment: document.getElementById('itemShelf').value.trim() || null,
        specific_location: document.getElementById('itemLocation').value.trim() || null,
        image: imageBase64,
        qr_code: qrContent,
        created_at: document.getElementById('editId').value 
          ? items.find(i => i.id === document.getElementById('editId').value)?.created_at 
          : new Date().toISOString()
      };

      if (document.getElementById('editId').value) {
        items = items.map(i => i.id === document.getElementById('editId').value ? newItem : i);
      } else {
        if (!recentRooms.includes(newItem.room)) recentRooms.unshift(newItem.room);
        if (newItem.container && !recentContainers.includes(newItem.container)) recentContainers.unshift(newItem.container);
        if (newItem.shelf_or_compartment && !recentShelves.includes(newItem.shelf_or_compartment)) recentShelves.unshift(newItem.shelf_or_compartment);
        recentRooms = recentRooms.slice(0, 20);
        recentContainers = recentContainers.slice(0, 20);
        recentShelves = recentShelves.slice(0, 20);
        items.push(newItem);
      }

      resetForm();
      if (!saveData()) {
        if (!document.getElementById('editId').value) items.pop();
        throw new Error('æ•°æ®è¿‡å¤§ï¼Œæ— æ³•ä¿å­˜');
      }
      alert(document.getElementById('editId').value ? 'âœ… ä¿®æ”¹æˆåŠŸï¼' : 'âœ… æ·»åŠ æˆåŠŸï¼');
    } catch (err) {
      console.error(err);
      alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + (err.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•'));
    } finally {
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('saveBtn').textContent = originalText;
    }
  });

  function resetForm() {
    document.getElementById('editId').value = '';
    document.getElementById('itemName').value = '';
    document.getElementById('itemQuantity').value = '1';
    document.getElementById('itemCategory').value = '';
    document.getElementById('itemContainer').value = '';
    document.getElementById('itemShelf').value = '';
    document.getElementById('itemLocation').value = '';
    document.getElementById('itemImage').value = '';
    document.getElementById('itemQrCode').value = '';
    document.getElementById('saveBtn').textContent = 'â• æ·»åŠ ç‰©å“';
  }

  document.getElementById('exportBtn').addEventListener('click', () => {
    if (items.length === 0) return alert('æ²¡æœ‰ç‰©å“å¯å¯¼å‡º');
    const blob = new Blob([JSON.stringify({ items, recentRooms, recentContainers, recentShelves }, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `HomeItems_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('âœ… å¯¼å‡ºæˆåŠŸï¼\nè¯·ä¿å­˜åˆ° iCloud Drive ä»¥è·¨è®¾å¤‡åŒæ­¥ã€‚');
    }, 100);
  });

  let importFile = document.createElement('input');
  importFile.type = 'file';
  importFile.accept = '.json';
  importFile.style.display = 'none';
  importFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!data.items) throw new Error('æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ items å­—æ®µ');
        if (!confirm(`å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼ˆå…± ${data.items.length} é¡¹ï¼‰ï¼Œç¡®å®šå¯¼å…¥ï¼Ÿ`)) return;
        safeImportData(data);
      } catch (err) {
        alert('å¯¼å…¥å¤±è´¥ï¼š' + (err.message || 'æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®'));
      }
    };
    reader.readAsText(file);
    importFile.value = '';
  });
  document.body.appendChild(importFile);
  document.getElementById('importBtn').addEventListener('click', () => importFile.click());

  document.getElementById('clearDataBtn').addEventListener('click', clearAllData);

  let roomChart, categoryChart, containerChart;

  function renderStats() {
    const ctx1 = document.getElementById('roomChart').getContext('2d');
    const ctx2 = document.getElementById('categoryChart').getContext('2d');
    const ctx3 = document.getElementById('containerChart').getContext('2d');

    const roomCount = {};
    items.forEach(i => {
      roomCount[i.room] = (roomCount[i.room] || 0) + (i.quantity || 1);
    });
    const roomLabels = Object.keys(roomCount);
    const roomData = Object.values(roomCount);

    const catCount = {};
    items.filter(i => i.category).forEach(i => {
      catCount[i.category] = (catCount[i.category] || 0) + (i.quantity || 1);
    });
    const catLabels = Object.keys(catCount);
    const catData = Object.values(catCount);

    const contCount = {};
    items.filter(i => i.container).forEach(i => {
      contCount[i.container] = (contCount[i.container] || 0) + (i.quantity || 1);
    });
    const sortedCont = Object.entries(contCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
    const contLabels = sortedCont.map(x => x[0]);
    const contData = sortedCont.map(x => x[1]);

    if (roomChart) roomChart.destroy();
    if (categoryChart) categoryChart.destroy();
    if (containerChart) containerChart.destroy();

    roomChart = new Chart(ctx1, {
      type: 'bar',
      data: { labels: roomLabels, datasets: [{ label: 'ç‰©å“æ€»æ•°é‡', data: roomData, backgroundColor: '#4A90E2' }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    categoryChart = new Chart(ctx2, {
      type: 'pie',
      data: { labels: catLabels, datasets: [{ data: catData, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }] },
      options: { responsive: true }
    });

    containerChart = new Chart(ctx3, {
      type: 'bar',
      data: { labels: contLabels, datasets: [{ label: 'ç‰©å“æ€»æ•°é‡', data: contData, backgroundColor: '#FF9F40' }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
    if (tabName === 'manage') {
      document.getElementById('managePanel').style.display = 'block';
      document.getElementById('statsPanel').style.display = 'none';
    } else {
      document.getElementById('managePanel').style.display = 'none';
      document.getElementById('statsPanel').style.display = 'block';
      renderStats();
    }
  }

  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      const tabName = e.currentTarget.dataset.tab;
      switchTab(tabName);
    });
  });

  function loadDataFromStorage() {
    try {
      const savedItems = localStorage.getItem('homeItems_v5');
      if (savedItems) items = JSON.parse(savedItems);
      const rooms = localStorage.getItem('recentRooms');
      if (rooms) recentRooms = JSON.parse(rooms);
      const containers = localStorage.getItem('recentContainers');
      if (containers) recentContainers = JSON.parse(containers);
      const shelves = localStorage.getItem('recentShelves');
      if (shelves) recentShelves = JSON.parse(shelves);
    } catch (e) {
      console.warn('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼', e);
    }
  }

  loadDataFromStorage();
  document.getElementById('searchInput').addEventListener('input', renderItems);
  renderFormOptions();
  renderItems();
  updateStorageWarning();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  }
});
</script>

</body>
</html>
