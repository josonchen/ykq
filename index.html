<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#4A90E2" />
  <title>ğŸ  å®¶ç”¨ç‰©å“ç®¡å®¶</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
      background: #f9f9f9;
      color: #333;
      line-height: 1.6;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      max-width: 600px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      padding: 16px;
      background: #4A90E2;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .container { padding: 16px; }
    input, select, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }
    textarea { height: 60px; resize: vertical; }
    button {
      background: #4A90E2;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button.secondary { background: #6c757d; }
    button.mini {
      width: auto;
      padding: 6px 12px;
      font-size: 14px;
      margin-left: 8px;
    }
    .item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .location-path {
      color: #666;
      font-size: 14px;
      margin: 6px 0;
    }
    .item img { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; }
    .tabs {
      display: flex;
      margin: 16px 0;
      gap: 8px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
    }
    .tab.active { background: #4A90E2; color: white; }
    canvas { max-width: 100%; margin: 20px 0; }
    footer { text-align: center; padding: 16px; color: #888; font-size: 14px; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ  å®¶ç”¨ç‰©å“ç®¡å®¶</h1>
  </header>

  <div class="container">
    <!-- Tab åˆ‡æ¢ -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('manage')">ç®¡ç†</div>
      <div class="tab" onclick="switchTab('stats')">ğŸ“Š ç»Ÿè®¡</div>
    </div>

    <!-- ç®¡ç†é¢æ¿ -->
    <div id="managePanel">
      <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ç‰©å“åç§°æˆ–ä½ç½®..." />

      <!-- è¡¨å• -->
      <div id="itemForm">
        <input type="hidden" id="editId" />
        <input type="text" id="itemName" placeholder="ç‰©å“åç§°ï¼ˆå¿…å¡«ï¼‰" />
        <input type="text" id="itemCategory" placeholder="åˆ†ç±»ï¼ˆå¦‚ï¼šå¨æˆ¿ç”µå™¨ï¼‰" list="categoryList" />

        <div style="display:flex;align-items:center;">
          <select id="itemRoom" style="flex:1;"></select>
          <button type="button" class="mini" onclick="addNewRoom()">+ æ–°å»º</button>
        </div>

        <div style="display:flex;align-items:center;">
          <select id="itemContainer" style="flex:1;">
            <option value="">å®¹å™¨ï¼ˆå¦‚ï¼šè¡£æŸœã€å·¥å…·ç®±ï¼‰</option>
          </select>
          <button type="button" class="mini" onclick="addNewContainer()">+ æ–°å»º</button>
        </div>

        <input type="text" id="itemShelf" placeholder="å±‚/æ ¼ï¼ˆå¦‚ï¼šä¸Šå±‚ã€ç¬¬äºŒæ ¼ï¼‰" list="shelfList" />
        <textarea id="itemLocation" placeholder="å…·ä½“ä½ç½®æè¿°ï¼ˆå¦‚ï¼šå·¦ä¸Šè§’æŠ½å±‰å†…ï¼‰"></textarea>

        <input type="file" id="itemImage" accept="image/*" capture="environment" />
        <input type="file" id="itemQrCode" accept="image/*" placeholder="å¯é€‰ï¼šä¸Šä¼ äºŒç»´ç æ ‡ç­¾" />

        <button id="saveBtn">â• æ·»åŠ ç‰©å“</button>
      </div>

      <!-- åŠŸèƒ½æŒ‰é’® -->
      <div style="display:flex;gap:8px;margin:16px 0;flex-wrap:wrap;">
        <button id="exportBtn" class="secondary">ğŸ“¤ å¯¼å‡ºåˆ° iCloud</button>
        <button id="importBtn" class="secondary">ğŸ“¥ ä» iCloud å¯¼å…¥</button>
      </div>

      <!-- ç‰©å“åˆ—è¡¨ -->
      <div id="itemsList"></div>
    </div>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div id="statsPanel" style="display:none;">
      <h3>ğŸ“¦ ç‰©å“æ€»æ•°ï¼š<span id="totalItems">0</span></h3>
      <h4>æŒ‰æˆ¿é—´åˆ†å¸ƒ</h4>
      <canvas id="roomChart"></canvas>
      <h4>æŒ‰åˆ†ç±»åˆ†å¸ƒ</h4>
      <canvas id="categoryChart"></canvas>
      <h4>æŒ‰å®¹å™¨åˆ†å¸ƒï¼ˆTop 5ï¼‰</h4>
      <canvas id="containerChart"></canvas>
    </div>
  </div>

  <!-- datalist for suggestions -->
  <datalist id="categoryList"></datalist>
  <datalist id="shelfList"></datalist>

  <footer>
    æ•°æ®ä¿å­˜åœ¨æœ¬æœº Â· å¯¼å‡º JSON åˆ° iCloud Drive å¯è·¨è®¾å¤‡åŒæ­¥
  </footer>

  <script>
    // ======================
    // æ•°æ®æ¨¡å‹
    // ======================
    let items = JSON.parse(localStorage.getItem('homeItems_v3') || '[]');
    let recentRooms = JSON.parse(localStorage.getItem('recentRooms') || '["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"]');
    let recentContainers = JSON.parse(localStorage.getItem('recentContainers') || '["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"]');
    let recentShelves = JSON.parse(localStorage.getItem('recentShelves') || '["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"]');

    // ======================
    // DOM å…ƒç´ 
    // ======================
    const managePanel = document.getElementById('managePanel');
    const statsPanel = document.getElementById('statsPanel');
    const itemsList = document.getElementById('itemsList');
    const searchInput = document.getElementById('searchInput');
    const itemName = document.getElementById('itemName');
    const itemCategory = document.getElementById('itemCategory');
    const itemRoom = document.getElementById('itemRoom');
    const itemContainer = document.getElementById('itemContainer');
    const itemShelf = document.getElementById('itemShelf');
    const itemLocation = document.getElementById('itemLocation');
    const itemImage = document.getElementById('itemImage');
    const itemQrCode = document.getElementById('itemQrCode');
    const saveBtn = document.getElementById('saveBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const editId = document.getElementById('editId');
    const totalItemsEl = document.getElementById('totalItems');

    // ======================
    // å·¥å…·å‡½æ•°
    // ======================
    function uuid() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    function getLocationPath(item) {
      let path = item.room;
      if (item.container) path += ` > ${item.container}`;
      if (item.shelf_or_compartment) path += ` > ${item.shelf_or_compartment}`;
      return path;
    }

    function saveData() {
      localStorage.setItem('homeItems_v3', JSON.stringify(items));
      localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
      localStorage.setItem('recentContainers', JSON.stringify(recentContainers));
      localStorage.setItem('recentShelves', JSON.stringify(recentShelves));
      renderFormOptions();
      renderItems();
      renderStats();
    }

    // ======================
    // æ¸²æŸ“è¡¨å•é€‰é¡¹
    // ======================
    function renderFormOptions() {
      itemRoom.innerHTML = '';
      recentRooms.forEach(room => {
        const opt = document.createElement('option');
        opt.value = room;
        opt.textContent = room;
        itemRoom.appendChild(opt);
      });

      const containerOpts = recentContainers.map(c => `<option value="${c}">${c}</option>`).join('');
      itemContainer.innerHTML = `<option value="">å®¹å™¨ï¼ˆå¦‚ï¼šè¡£æŸœã€å·¥å…·ç®±ï¼‰</option>${containerOpts}`;

      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = '';
      const categories = [...new Set(items.map(i => i.category).filter(Boolean))];
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        categoryList.appendChild(opt);
      });

      const shelfList = document.getElementById('shelfList');
      shelfList.innerHTML = '';
      recentShelves.forEach(shelf => {
        const opt = document.createElement('option');
        opt.value = shelf;
        shelfList.appendChild(opt);
      });
    }

    // ======================
    // æ¸²æŸ“ç‰©å“åˆ—è¡¨
    // ======================
    function renderItems() {
      const term = searchInput.value.trim().toLowerCase();
      const filtered = items.filter(item =>
        item.name.toLowerCase().includes(term) ||
        getLocationPath(item).toLowerCase().includes(term) ||
        (item.specific_location && item.specific_location.toLowerCase().includes(term))
      );

      itemsList.innerHTML = filtered.length === 0
        ? '<p style="text-align:center;color:#888;">æš‚æ— ç‰©å“</p>'
        : filtered.map(item => `
          <div class="item">
            <strong>${item.name}</strong>
            ${item.category ? `<br><small>ğŸ“‚ ${item.category}</small>` : ''}
            <div class="location-path">${getLocationPath(item)}</div>
            ${item.specific_location ? `<div>${item.specific_location}</div>` : ''}
            ${item.image ? `<img src="${item.image}" alt="${item.name}" style="max-height:100px;">` : ''}
            ${item.qr_code ? `<img src="${item.qr_code}" alt="QR" style="width:60px;height:60px;margin-top:8px;">` : ''}
            <div style="margin-top:10px;">
              <button class="secondary" style="padding:6px 10px;font-size:14px;" onclick="editItem('${item.id}')">âœï¸ ç¼–è¾‘</button>
              <button class="secondary" style="padding:6px 10px;font-size:14px;" onclick="deleteItem('${item.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
          </div>
        `).join('');

      totalItemsEl.textContent = items.length;
    }

    // ======================
    // ç¼–è¾‘ & åˆ é™¤
    // ======================
    function editItem(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;

      editId.value = item.id;
      itemName.value = item.name;
      itemCategory.value = item.category || '';
      itemRoom.value = item.room;
      itemContainer.value = item.container || '';
      itemShelf.value = item.shelf_or_compartment || '';
      itemLocation.value = item.specific_location || '';

      saveBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
      window.scrollTo(0, 0);
    }

    function deleteItem(id) {
      if (confirm('ç¡®å®šåˆ é™¤æ­¤ç‰©å“ï¼Ÿ')) {
        items = items.filter(item => item.id !== id);
        saveData();
      }
    }

    // ======================
    // ä¿å­˜ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¼‰
    // ======================
    saveBtn.addEventListener('click', () => {
      const name = itemName.value.trim();
      const room = itemRoom.value.trim();
      if (!name || !room) {
        alert('è¯·å¡«å†™ç‰©å“åç§°å’Œæˆ¿é—´');
        return;
      }

      const promises = [];
      let imageBase64 = '';
      let qrBase64 = '';

      if (itemImage.files[0]) {
        promises.push(new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = e => {
            imageBase64 = e.target.result;
            resolve();
          };
          reader.readAsDataURL(itemImage.files[0]);
        }));
      }
      if (itemQrCode.files[0]) {
        promises.push(new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = e => {
            qrBase64 = e.target.result;
            resolve();
          };
          reader.readAsDataURL(itemQrCode.files[0]);
        }));
      }

      Promise.all(promises).then(() => {
        const newItem = {
          id: editId.value || uuid(),
          name,
          category: itemCategory.value.trim() || null,
          room,
          container: itemContainer.value.trim() || null,
          shelf_or_compartment: itemShelf.value.trim() || null,
          specific_location: itemLocation.value.trim() || null,
          image: imageBase64,
          qr_code: qrBase64,
          created_at: editId.value ? items.find(i => i.id === editId.value)?.created_at : new Date().toISOString()
        };

        if (editId.value) {
          // Update
          items = items.map(i => i.id === editId.value ? newItem : i);
        } else {
          // Add
          if (!recentRooms.includes(newItem.room)) recentRooms.unshift(newItem.room);
          if (newItem.container && !recentContainers.includes(newItem.container)) recentContainers.unshift(newItem.container);
          if (newItem.shelf_or_compartment && !recentShelves.includes(newItem.shelf_or_compartment)) recentShelves.unshift(newItem.shelf_or_compartment);
          recentRooms = recentRooms.slice(0, 20);
          recentContainers = recentContainers.slice(0, 20);
          recentShelves = recentShelves.slice(0, 20);
          items.push(newItem);
        }

        resetForm();
        saveData();
      });
    });

    function resetForm() {
      editId.value = '';
      itemName.value = '';
      itemCategory.value = '';
      itemShelf.value = '';
      itemLocation.value = '';
      itemImage.value = '';
      itemQrCode.value = '';
      saveBtn.textContent = 'â• æ·»åŠ ç‰©å“';
    }

    // ======================
    // å¿«é€Ÿè¾“å…¥
    // ======================
    function addNewRoom() {
      const newRoom = prompt('è¯·è¾“å…¥æ–°æˆ¿é—´åç§°ï¼š');
      if (newRoom && newRoom.trim() && !recentRooms.includes(newRoom.trim())) {
        recentRooms.unshift(newRoom.trim());
        saveData();
      }
    }

    function addNewContainer() {
      const newContainer = prompt('è¯·è¾“å…¥æ–°å®¹å™¨åç§°ï¼š');
      if (newContainer && newContainer.trim() && !recentContainers.includes(newContainer.trim())) {
        recentContainers.unshift(newContainer.trim());
        saveData();
      }
    }

    // ======================
    // å¯¼å…¥å¯¼å‡º
    // ======================
    exportBtn.addEventListener('click', () => {
      if (items.length === 0) return alert('æ²¡æœ‰ç‰©å“å¯å¯¼å‡º');
      const blob = new Blob([JSON.stringify({ items, recentRooms, recentContainers, recentShelves }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `HomeItems_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('âœ… å¯¼å‡ºæˆåŠŸï¼\nè¯·ä¿å­˜åˆ° iCloud Drive ä»¥è·¨è®¾å¤‡åŒæ­¥ã€‚');
      }, 100);
    });

    let importFile = document.createElement('input');
    importFile.type = 'file';
    importFile.accept = '.json';
    importFile.style.display = 'none';
    importFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data.items) throw new Error('æ ¼å¼é”™è¯¯');
          if (!confirm(`å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼ˆå…± ${data.items.length} é¡¹ï¼‰ï¼Œç¡®å®šå¯¼å…¥ï¼Ÿ`)) return;
          
          items = data.items;
          recentRooms = data.recentRooms || recentRooms;
          recentContainers = data.recentContainers || recentContainers;
          recentShelves = data.recentShelves || recentShelves;
          saveData();
          alert('å¯¼å…¥æˆåŠŸï¼');
        } catch (err) {
          alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
        }
      };
      reader.readAsText(file);
      importFile.value = '';
    });
    document.body.appendChild(importFile);
    importBtn.addEventListener('click', () => importFile.click());

    // ======================
    // ç»Ÿè®¡åˆ†æ
    // ======================
    let roomChart, categoryChart, containerChart;

    function renderStats() {
      const ctx1 = document.getElementById('roomChart').getContext('2d');
      const ctx2 = document.getElementById('categoryChart').getContext('2d');
      const ctx3 = document.getElementById('containerChart').getContext('2d');

      // æŒ‰æˆ¿é—´ç»Ÿè®¡
      const roomCount = {};
      items.forEach(i => {
        roomCount[i.room] = (roomCount[i.room] || 0) + 1;
      });
      const roomLabels = Object.keys(roomCount);
      const roomData = Object.values(roomCount);

      // æŒ‰åˆ†ç±»ç»Ÿè®¡
      const catCount = {};
      items.filter(i => i.category).forEach(i => {
        catCount[i.category] = (catCount[i.category] || 0) + 1;
      });
      const catLabels = Object.keys(catCount);
      const catData = Object.values(catCount);

      // æŒ‰å®¹å™¨ç»Ÿè®¡ï¼ˆTop 5ï¼‰
      const contCount = {};
      items.filter(i => i.container).forEach(i => {
        contCount[i.container] = (contCount[i.container] || 0) + 1;
      });
      const sortedCont = Object.entries(contCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const contLabels = sortedCont.map(x => x[0]);
      const contData = sortedCont.map(x => x[1]);

      // Destroy old charts
      if (roomChart) roomChart.destroy();
      if (categoryChart) categoryChart.destroy();
      if (containerChart) containerChart.destroy();

      roomChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: roomLabels,
          datasets: [{ label: 'ç‰©å“æ•°é‡', data: roomData, backgroundColor: '#4A90E2' }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      categoryChart = new Chart(ctx2, {
        type: 'pie',
        data: {
          labels: catLabels,
          datasets: [{ data: catData, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }]
        },
        options: { responsive: true }
      });

      containerChart = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: contLabels,
          datasets: [{ label: 'ç‰©å“æ•°é‡', data: contData, backgroundColor: '#FF9F40' }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    // ======================
    // Tab åˆ‡æ¢
    // ======================
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      if (tab === 'manage') {
        managePanel.style.display = 'block';
        statsPanel.style.display = 'none';
      } else {
        managePanel.style.display = 'none';
        statsPanel.style.display = 'block';
        renderStats();
      }
    }

    // ======================
    // åˆå§‹åŒ–
    // ======================
    searchInput.addEventListener('input', renderItems);
    renderFormOptions();
    renderItems();

    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>