<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ğŸ  å®¶åº­ç‰©å“ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css">
  <style>
    /* === åŸºç¡€æ ·å¼ === */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
    body { padding: 12px; background: #f2f2f7; color: #1c1c1e; line-height: 1.5; padding-bottom: 40px; }
    
    h1 { text-align: center; margin: 12px 0 20px; font-size: 20px; font-weight: 600; color: #000; }
    .tab-bar { display: flex; margin-bottom: 16px; background: #e5e5ea; border-radius: 10px; padding: 2px; }
    .tab { flex: 1; padding: 8px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 14px; color: #8e8e93; transition: all 0.2s; }
    .tab.active { background: #fff; color: #007aff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: 500; }
    
    .panel { display: none; animation: fadeIn 0.3s ease; }
    #managePanel { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* === è¡¨å•å…ƒç´  === */
    label { display: block; font-weight: 600; margin-top: 14px; margin-bottom: 6px; color: #333; font-size: 14px; }
    input, select, textarea { 
      width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; background: #fff; appearance: none;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #007aff; }
    textarea { resize: vertical; min-height: 60px; }
    
    button { 
      width: 100%; background: #007aff; color: white; border: none; cursor: pointer; padding: 14px; 
      border-radius: 12px; font-size: 16px; font-weight: 500; margin-top: 10px; 
      active: scale(0.98); transition: transform 0.1s;
    }
    button:active { transform: scale(0.98); opacity: 0.9; }
    button.secondary { background: #e5e5ea; color: #007aff; }
    button.danger { background: #ff3b30; color: white; }
    button.warning { background: #ff9500; color: white; }
    button:disabled { opacity: 0.5; cursor: not-allowed; background: #ccc; color: #666; }

    .input-group { display: flex; gap: 8px; align-items: flex-start; }
    .input-group input, .input-group select { flex: 1; }
    .input-group button { width: auto; margin-top: 0; padding: 12px; white-space: nowrap; }

    #ocrBtn { background: #34c759; color: white; padding: 0 16px; display: flex; align-items: center; justify-content: center; }

    /* === åˆ—è¡¨å¸ƒå±€ === */
    #itemsList { margin-top: 20px; }
    .item { 
      background: white; padding: 12px; margin-bottom: 12px; 
      border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
    }
    .item-header { 
      display: flex; justify-content: space-between; align-items: center; 
      border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; margin-bottom: 8px;
    }
    .item-name { font-weight: 600; font-size: 17px; color: #000; }
    .quantity-badge { background: #e3f2fd; color: #007aff; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }

    .item-body { display: flex; justify-content: space-between; gap: 12px; }
    .item-info { flex: 1; min-width: 0; }
    .info-row { font-size: 13px; color: #666; margin-bottom: 4px; line-height: 1.4; display: flex; align-items: baseline; }
    .item-thumb {
      width: 80px; height: 80px; object-fit: cover; 
      border-radius: 8px; border: 1px solid #eee; flex-shrink: 0; background-color: #f9f9f9;
    }
    .item-actions { margin-top: 12px; display: flex; gap: 10px; }
    .item-actions button { margin-top: 0; padding: 8px; font-size: 13px; border-radius: 8px; background: #f2f2f7; color: #333; }
    .item-actions button.edit-btn { color: #007aff; }
    .item-actions button.delete-btn { color: #ff3b30; }

    /* === å›¾ç‰‡åŒºåŸŸ === */
    #photoUploadArea {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; border: 2px dashed #d1d1d6; border-radius: 12px;
      background: #fafafa; color: #8e8e93; cursor: pointer; margin-top: 10px;
    }
    #photoPreviewInForm {
      max-width: 100%; max-height: 200px; margin-top: 12px; border-radius: 8px; 
      display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* === å›¾è¡¨ === */
    .chart-container { position: relative; height: 220px; margin: 20px 0; width: 100%; background: #fff; padding: 10px; border-radius: 12px; }

    /* === Modals === */
    #customModal {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    #modalContent { background: white; padding: 24px; border-radius: 16px; width: 85%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    #modalTitle { font-weight: 600; font-size: 18px; margin-bottom: 16px; text-align: center; }
    .modal-buttons { display: flex; gap: 12px; margin-top: 20px; }

    /* è£å‰ª Modal */
    #cropModal {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #000; z-index: 3000; flex-direction: column;
    }
    .crop-container { flex: 1; position: relative; overflow: hidden; }
    .crop-toolbar { 
      height: 90px; background: #1c1c1e; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; padding-bottom: 20px;
    }
    .crop-toolbar button { width: auto; margin: 0; padding: 8px 16px; font-size: 14px; border-radius: 18px; }
    
    #loadingMask {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.9); z-index: 4000; flex-direction: column; align-items: center; justify-content: center;
    }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007aff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;}
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<h1>ğŸ  å®¶åº­ç‰©å“ç®¡ç†</h1>

<div class="tab-bar">
  <div class="tab active" data-tab="manage">ğŸ“¦ ç‰©å“ç®¡ç†</div>
  <div class="tab" data-tab="stats">ğŸ“Š æ•°æ®ç»Ÿè®¡</div>
</div>

<div id="managePanel" class="panel">

  <label>ç‰©å“åŸºæœ¬ä¿¡æ¯</label>
  <div class="input-group">
    <button type="button" id="ocrBtn">ğŸ“· æ‹å­—</button>
    <input type="text" id="itemName" placeholder="ç‰©å“åç§°" />
    <input type="number" id="itemQuantity" style="width: 70px; flex:none;" placeholder="æ•°é‡" value="1" min="1" inputmode="numeric" />
  </div>
  <div style="font-size:12px; color:#888; margin-top:4px;">ğŸ’¡ æç¤ºï¼šç‚¹å‡»â€œæ‹å­—â€åï¼Œæ¡†é€‰æ–‡å­—åŒºåŸŸè¶Šç²¾å‡†ï¼Œè¯†åˆ«è¶Šå‡†ç¡®ã€‚</div>

  <input type="file" id="fileInput" accept="image/*" style="display:none;" />

  <label>å­˜æ”¾ä½ç½®</label>
  <div class="input-group">
    <select id="itemRoom"><option value="">é€‰æ‹©æˆ¿é—´</option></select>
    <button type="button" class="secondary" id="addRoomBtn">â•</button>
  </div>
  
  <div class="input-group" style="margin-top: 8px;">
    <input type="text" id="itemContainer" placeholder="å®¹å™¨ (å¦‚: æŠ½å±‰ã€ç®±å­)" list="containerList" />
    <datalist id="containerList"></datalist>
    <button type="button" class="secondary" id="addContainerBtn">â•</button>
  </div>

  <div class="input-group" style="margin-top: 8px;">
    <input type="text" id="itemShelf" placeholder="å…·ä½“å±‚/æ ¼ (å¯é€‰)" list="shelfList" />
    <datalist id="shelfList"></datalist>
  </div>

  <label>è¯¦ç»†æè¿°/åˆ†ç±»</label>
  <input type="text" id="itemCategory" placeholder="åˆ†ç±» (å¦‚: å·¥å…·ã€æ•°ç )" list="categoryList" style="margin-bottom:8px;" />
  <datalist id="categoryList"></datalist>
  <textarea id="itemLocation" placeholder="å¤‡æ³¨æˆ–æ›´å…·ä½“çš„ä½ç½®æè¿°..."></textarea>

  <label>ç‰©å“ç…§ç‰‡ (æ”¯æŒè£å‰ª)</label>
  <div id="photoUploadArea">
    <span>ğŸ“¸ ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©ç…§ç‰‡</span>
    <img id="photoPreviewInForm" src="" alt="é¢„è§ˆ" />
  </div>

  <input type="hidden" id="editId" value="" />
  <button id="saveBtn">â• æ·»åŠ ç‰©å“</button>

  <hr style="margin: 24px 0; border: 0; border-top: 1px solid #e0e0e0;" />

  <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢åç§°ã€ä½ç½®..." style="background:#fff url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23999\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><circle cx=\'11\' cy=\'11\' r=\'8\'></circle><line x1=\'21\' y1=\'21\' x2=\'16.65\' y2=\'16.65\'></line></svg>') no-repeat 12px center; padding-left: 36px;" />
  
  <div id="itemsList"></div>
  
  <p style="text-align:center; margin:16px 0; color:#8e8e93; font-size:13px;">
    å…± <span id="totalItems">0</span> é¡¹ â€¢ æ€»è®¡ <span id="totalQuantity">0</span> ä¸ª
  </p>

  <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
    <button id="exportBtn" class="secondary">ğŸ“¤ å¤‡ä»½</button>
    <button id="importBtn" class="warning">ğŸ“¥ æ¢å¤</button>
    <button id="clearDataBtn" class="danger">ğŸ—‘ï¸ æ¸…ç©º</button>
  </div>
</div>

<div id="statsPanel" class="panel">
  <div class="chart-container"><canvas id="roomChart"></canvas></div>
  <div class="chart-container"><canvas id="categoryChart"></canvas></div>
  <div class="chart-container"><canvas id="containerChart"></canvas></div>
</div>

<div id="customModal">
  <div id="modalContent">
    <div id="modalTitle">æ–°å¢é€‰é¡¹</div>
    <input type="text" id="modalInput" placeholder="è¯·è¾“å…¥åç§°" maxlength="20" />
    <div class="modal-buttons">
      <button id="modalCancelBtn" class="secondary">å–æ¶ˆ</button>
      <button id="modalConfirmBtn">ç¡®å®š</button>
    </div>
  </div>
</div>

<div id="cropModal">
  <div class="crop-container">
    <img id="cropImage" src="" style="max-width: 100%;" />
  </div>
  <div class="crop-toolbar">
    <button id="cancelCropBtn" style="background:#333; color:#fff;">å–æ¶ˆ</button>
    <div id="cropTitle" style="color:white; font-size:14px; font-weight:bold;">å›¾ç‰‡è£å‰ª</div>
    <button id="confirmCropBtn" style="background:#34c759; color:#fff;">âœ… ç¡®è®¤</button>
  </div>
</div>

<div id="loadingMask">
  <div class="spinner"></div>
  <div id="loadingText">å¤„ç†ä¸­...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>

<script>
// === Service Worker ===
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(err => console.log('SW Fail', err));
}

// === IndexedDB ===
const DB_NAME = 'HomeItemsDB';
const DB_VERSION = 1;
const STORE_NAME = 'items';
const db = {
  open: () => new Promise((resolve, reject) => {
    const r = indexedDB.open(DB_NAME, DB_VERSION);
    r.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains(STORE_NAME)) e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id' }); };
    r.onsuccess = e => resolve(e.target.result);
    r.onerror = e => reject(e);
  }),
  getAll: async () => { const d = await db.open(); return new Promise((resolve) => { d.transaction(STORE_NAME,'readonly').objectStore(STORE_NAME).getAll().onsuccess = e => resolve(e.target.result||[]); }); },
  put: async (item) => { const d = await db.open(); return new Promise((resolve) => { d.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).put(item).onsuccess = resolve; }); },
  delete: async (id) => { const d = await db.open(); return new Promise((resolve) => { d.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).delete(id).onsuccess = resolve; }); },
  clear: async () => { const d = await db.open(); return new Promise((resolve) => { d.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).clear().onsuccess = resolve; }); }
};

// === å…¨å±€å˜é‡ ===
let items = [];
let recentRooms = ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];
let recentContainers = ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];
let recentShelves = ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];
let roomChartInstance, categoryChartInstance, containerChartInstance;
let userSelectedNewImage = false;
let pendingItemImageBase64 = '';
let cropper = null;
let currentCropAction = ''; // 'ocr' æˆ– 'photo'

// === ä¸»é€»è¾‘ ===
async function loadData() {
  showLoading('åŠ è½½æ•°æ®...');
  try {
    if(localStorage.getItem('recentRooms')) recentRooms = JSON.parse(localStorage.getItem('recentRooms'));
    if(localStorage.getItem('recentContainers')) recentContainers = JSON.parse(localStorage.getItem('recentContainers'));
    if(localStorage.getItem('recentShelves')) recentShelves = JSON.parse(localStorage.getItem('recentShelves'));

    items = await db.getAll();
    if (items.length === 0 && localStorage.getItem('homeItems_v5')) {
      const old = JSON.parse(localStorage.getItem('homeItems_v5'));
      if(Array.isArray(old)) { for(let i of old) await db.put(i); items=old; localStorage.removeItem('homeItems_v5'); }
    }
  } catch (e) { console.error(e); } finally { hideLoading(); renderItems(); renderOptions(); }
}

function renderOptions(curr = null) {
  const mkOpt = arr => arr.map(v => `<option value="${v}">${v}</option>`).join('');
  document.getElementById('itemRoom').innerHTML = '<option value="">è¯·é€‰æ‹©æˆ¿é—´</option>' + mkOpt([...new Set([...recentRooms, ...(curr?.room?[curr.room]:[])])]);
  document.getElementById('containerList').innerHTML = mkOpt([...new Set([...recentContainers, ...(curr?.container?[curr.container]:[])])]);
  document.getElementById('categoryList').innerHTML = mkOpt([...new Set(items.map(i=>i.category).filter(Boolean))]);
  document.getElementById('shelfList').innerHTML = mkOpt(recentShelves);
}

function renderItems() {
  const term = document.getElementById('searchInput').value.trim().toLowerCase();
  const listEl = document.getElementById('itemsList');
  const filtered = [...items].reverse().filter(item => {
    return `${item.name} ${item.room} ${item.container||''} ${item.shelf||''} ${item.specific_location||''}`.toLowerCase().includes(term);
  });

  listEl.innerHTML = filtered.length === 0 ? '<div style="text-align:center;padding:40px;color:#ccc;">æš‚æ— åŒ¹é…ç‰©å“</div>' : filtered.map(item => `
    <div class="item" data-id="${item.id}">
      <div class="item-header"><span class="item-name">${item.name}</span>${item.quantity>1?`<span class="quantity-badge">Ã—${item.quantity}</span>`:''}</div>
      <div class="item-body">
        <div class="item-info">
          <div class="info-row"><strong>ğŸ“</strong> ${item.room}${item.container?` > ${item.container}`:''}${item.shelf?` > ${item.shelf}`:''}</div>
          ${item.category?`<div class="info-row"><strong>ğŸ“‚</strong> ${item.category}</div>`:''}
          ${item.specific_location?`<div class="info-row" style="color:#888;">ğŸ“ ${item.specific_location}</div>`:''}
        </div>
        ${item.image?`<img class="item-thumb" src="${item.image}" onclick="viewImage('${item.id}')">`:'<div style="width:0;"></div>'}
      </div>
      <div class="item-actions"><button class="edit-btn">âœï¸ ç¼–è¾‘</button><button class="delete-btn">ğŸ—‘ï¸ åˆ é™¤</button></div>
    </div>`).join('');
  
  document.getElementById('totalItems').textContent = items.length;
  document.getElementById('totalQuantity').textContent = items.reduce((a,b)=>a+(parseInt(b.quantity)||1),0);
}

window.viewImage = (id) => {
  const item = items.find(i => i.id === id);
  if(item?.image) { const w = window.open(""); w.document.write(`<img src="${item.image}" style="width:100%;"/>`); }
};

// === ç»Ÿä¸€çš„å›¾ç‰‡é€‰æ‹©ä¸è£å‰ªé€»è¾‘ ===
const fileInput = document.getElementById('fileInput');

// è§¦å‘é€‰æ‹©
document.getElementById('ocrBtn').onclick = () => { currentCropAction = 'ocr'; fileInput.click(); };
document.getElementById('photoUploadArea').onclick = () => { currentCropAction = 'photo'; fileInput.click(); };

// æ–‡ä»¶é€‰æ‹©å -> æ‰“å¼€è£å‰ª
fileInput.onchange = (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    const img = document.getElementById('cropImage');
    img.src = evt.target.result;
    document.getElementById('cropModal').style.display = 'flex';
    document.getElementById('cropTitle').innerText = currentCropAction === 'ocr' ? 'æ¡†é€‰æ–‡å­—åŒºåŸŸ' : 'è£å‰ªç‰©å“ç…§ç‰‡';
    document.getElementById('confirmCropBtn').innerText = currentCropAction === 'ocr' ? 'è¯†åˆ«' : 'ç¡®è®¤ä½¿ç”¨';
    
    if(cropper) cropper.destroy();
    cropper = new Cropper(img, {
      viewMode: 1, 
      dragMode: 'move', 
      autoCropArea: 0.8,
      initialAspectRatio: NaN // è‡ªç”±æ¯”ä¾‹
    });
  };
  reader.readAsDataURL(file);
  fileInput.value = ''; // é‡ç½®ï¼Œå…è®¸é‡å¤é€‰åŒä¸€æ–‡ä»¶
};

document.getElementById('cancelCropBtn').onclick = () => {
  document.getElementById('cropModal').style.display = 'none';
  if(cropper) cropper.destroy();
};

document.getElementById('confirmCropBtn').onclick = async () => {
  if(!cropper) return;
  
  // 1. è·å–è£å‰ªåçš„ Canvas
  const canvas = cropper.getCroppedCanvas();
  document.getElementById('cropModal').style.display = 'none';
  if(cropper) cropper.destroy();

  // 2. æ ¹æ®å½“å‰åŠ¨ä½œåˆ†æµ
  if (currentCropAction === 'ocr') {
    await performOCR(canvas);
  } else {
    // ç‰©å“ç…§ç‰‡ï¼šå‹ç¼©å¹¶é¢„è§ˆ
    const base64 = canvas.toDataURL('image/jpeg', 0.7); // è´¨é‡ 0.7
    document.getElementById('photoPreviewInForm').src = base64;
    document.getElementById('photoPreviewInForm').style.display = 'block';
    pendingItemImageBase64 = base64;
    userSelectedNewImage = true;
  }
};

// === OCR æ ¸å¿ƒé€»è¾‘ (å«å›¾åƒå¢å¼º) ===
async function performOCR(canvas) {
  showLoading('æ­£åœ¨å¢å¼ºå›¾åƒå¹¶è¯†åˆ«...');
  try {
    // A. å›¾åƒé¢„å¤„ç†ï¼šè½¬é»‘ç™½äºŒå€¼åŒ–ï¼Œæé«˜ OCR å‡†ç¡®ç‡
    const ctx = canvas.getContext('2d');
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const d = imgData.data;
    for (let i = 0; i < d.length; i += 4) {
      // ç°åº¦å…¬å¼
      let gray = 0.2126 * d[i] + 0.7152 * d[i+1] + 0.0722 * d[i+2];
      // é˜ˆå€¼å¤„ç† (128) - ç®€å•çš„äºŒå€¼åŒ–
      let val = (gray >= 120) ? 255 : 0; 
      d[i] = d[i+1] = d[i+2] = val;
    }
    ctx.putImageData(imgData, 0, 0);
    const processedImage = canvas.toDataURL('image/png');

    // B. æ‰§è¡Œè¯†åˆ«
    const worker = await Tesseract.createWorker('chi_sim+eng');
    const ret = await worker.recognize(processedImage);
    await worker.terminate();

    const text = ret.data.text.replace(/\s+/g, '').trim();
    if(text) {
      document.getElementById('itemName').value = text;
    } else {
      alert('æœªè¯†åˆ«åˆ°æ¸…æ™°æ–‡å­—ï¼Œè¯·é‡è¯•');
    }
  } catch (err) {
    console.error(err);
    alert('è¯†åˆ«å¤±è´¥: ' + err.message);
  } finally {
    hideLoading();
  }
}

// === ä¿å­˜é€»è¾‘ ===
document.getElementById('saveBtn').onclick = async () => {
  const name = document.getElementById('itemName').value.trim();
  const room = document.getElementById('itemRoom').value;
  if(!name || !room) return alert('åç§°å’Œæˆ¿é—´å¿…å¡«');

  const editId = document.getElementById('editId').value;
  const oldItem = editId ? items.find(i=>i.id===editId) : null;
  
  // å›¾ç‰‡é€»è¾‘ï¼šä¼˜å…ˆç”¨æ–°å›¾ -> å¦åˆ™ç”¨æ—§å›¾ -> å¦åˆ™ä¸ºç©º
  let img = userSelectedNewImage ? pendingItemImageBase64 : (oldItem?.image || '');

  const item = {
    id: editId || Date.now().toString(36),
    name, room, image: img,
    quantity: parseInt(document.getElementById('itemQuantity').value)||1,
    container: document.getElementById('itemContainer').value.trim(),
    shelf: document.getElementById('itemShelf').value.trim(),
    category: document.getElementById('itemCategory').value.trim(),
    specific_location: document.getElementById('itemLocation').value.trim(),
    updatedAt: Date.now()
  };

  try {
    await db.put(item);
    if(editId) { const i=items.findIndex(x=>x.id===editId); if(i>-1) items[i]=item; } else items.push(item);
    
    // ä¿å­˜å¸¸ç”¨é…ç½®
    localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
    localStorage.setItem('recentContainers', JSON.stringify(recentContainers));
    localStorage.setItem('recentShelves', JSON.stringify(recentShelves));

    resetForm(); renderItems();
    alert(editId ? 'ä¿®æ”¹æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ');
  } catch(e) { alert('ä¿å­˜å¤±è´¥:'+e.message); }
};

// === è¾…åŠ©åŠŸèƒ½ ===
document.getElementById('itemsList').onclick = async (e) => {
  if(e.target.classList.contains('delete-btn')) {
    if(!confirm('ç¡®å®šåˆ é™¤?')) return;
    const id = e.target.closest('.item').dataset.id;
    await db.delete(id); items = items.filter(i=>i.id!==id); renderItems();
  }
  if(e.target.classList.contains('edit-btn')) {
    const id = e.target.closest('.item').dataset.id;
    const item = items.find(i=>i.id===id);
    if(!item) return;
    document.getElementById('editId').value = item.id;
    document.getElementById('itemName').value = item.name;
    document.getElementById('itemQuantity').value = item.quantity;
    document.getElementById('itemCategory').value = item.category||'';
    document.getElementById('itemShelf').value = item.shelf||'';
    document.getElementById('itemLocation').value = item.specific_location||'';
    document.getElementById('itemContainer').value = item.container||'';
    
    if(!recentRooms.includes(item.room)) recentRooms.push(item.room);
    renderOptions(item);
    document.getElementById('itemRoom').value = item.room;

    const prev = document.getElementById('photoPreviewInForm');
    if(item.image) { prev.src = item.image; prev.style.display='block'; } else { prev.style.display='none'; }
    
    userSelectedNewImage = false; pendingItemImageBase64 = '';
    document.getElementById('saveBtn').textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
    window.scrollTo({top:0, behavior:'smooth'});
  }
};

function resetForm() {
  document.getElementById('editId').value = '';
  document.querySelectorAll('input:not([type=hidden]), textarea, select').forEach(i=>i.value='');
  document.getElementById('itemQuantity').value=1;
  document.getElementById('photoPreviewInForm').style.display='none';
  document.getElementById('saveBtn').textContent = 'â• æ·»åŠ ç‰©å“';
  userSelectedNewImage = false; pendingItemImageBase64 = '';
}

function showLoading(txt) { document.getElementById('loadingText').innerText = txt; document.getElementById('loadingMask').style.display = 'flex'; }
function hideLoading() { document.getElementById('loadingMask').style.display = 'none'; }

// æ¨¡æ€æ¡†é€»è¾‘
let modalType = '';
const showModal = (t) => { modalType=t; document.getElementById('modalTitle').innerText=t==='room'?'æ–°å¢æˆ¿é—´':'æ–°å¢å®¹å™¨'; document.getElementById('customModal').style.display='flex'; document.getElementById('modalInput').focus(); };
document.getElementById('addRoomBtn').onclick=()=>showModal('room'); document.getElementById('addContainerBtn').onclick=()=>showModal('container');
document.getElementById('modalCancelBtn').onclick=()=>document.getElementById('customModal').style.display='none';
document.getElementById('modalConfirmBtn').onclick=()=>{
  const v = document.getElementById('modalInput').value.trim();
  if(v) { 
    if(modalType==='room' && !recentRooms.includes(v)) recentRooms.push(v);
    if(modalType==='container' && !recentContainers.includes(v)) recentContainers.push(v);
    renderOptions();
    localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
    localStorage.setItem('recentContainers', JSON.stringify(recentContainers));
  }
  document.getElementById('customModal').style.display='none'; document.getElementById('modalInput').value='';
};

// å¯¼å‡ºå¯¼å…¥
document.getElementById('exportBtn').onclick = () => {
  const url = URL.createObjectURL(new Blob([JSON.stringify({items, recentRooms, recentContainers, recentShelves},null,2)], {type:'application/json'}));
  const a = document.createElement('a'); a.href=url; a.download=`å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`; a.click();
};
document.getElementById('importBtn').onclick = () => {
  const inp = document.createElement('input'); inp.type='file';
  inp.onchange = async(e) => {
    showLoading('æ­£åœ¨å¯¼å…¥...');
    try {
      const d = JSON.parse(await e.target.files[0].text());
      if(d.items) { await db.clear(); for(let i of d.items) await db.put(i); }
      if(d.recentRooms) localStorage.setItem('recentRooms', JSON.stringify(d.recentRooms));
      if(d.recentContainers) localStorage.setItem('recentContainers', JSON.stringify(d.recentContainers));
      await loadData(); alert('å¯¼å…¥æˆåŠŸ');
    } catch(err){ alert('æ–‡ä»¶é”™è¯¯'); } finally { hideLoading(); }
  };
  inp.click();
};
document.getElementById('clearDataBtn').onclick = async () => { if(confirm('ç¡®å®šæ¸…ç©º?')) { await db.clear(); items=[]; renderItems(); } };

// å›¾è¡¨ä¸åˆå§‹åŒ–
document.querySelectorAll('.tab').forEach(t => t.onclick = function() {
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); this.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.style.display='none'); document.getElementById(this.dataset.tab+'Panel').style.display='block';
  if(this.dataset.tab==='stats') {
    if(roomChartInstance) roomChartInstance.destroy(); if(categoryChartInstance) categoryChartInstance.destroy(); if(containerChartInstance) containerChartInstance.destroy();
    const rd={}, cd={}, ctd={}; items.forEach(i=>{ rd[i.room]=(rd[i.room]||0)+1; if(i.category) cd[i.category]=(cd[i.category]||0)+1; if(i.container) ctd[i.container]=(ctd[i.container]||0)+1; });
    const ctx = (id) => document.getElementById(id).getContext('2d');
    roomChartInstance = new Chart(ctx('roomChart'), {type:'pie', data:{labels:Object.keys(rd), datasets:[{data:Object.values(rd), backgroundColor:['#007aff','#34c759','#ff9500','#ff3b30','#af52de']}]}, options:{maintainAspectRatio:false}});
    categoryChartInstance = new Chart(ctx('categoryChart'), {type:'doughnut', data:{labels:Object.keys(cd), datasets:[{data:Object.values(cd), backgroundColor:['#5ac8fa','#ffcc00','#ff2d55','#5856d6']}]}, options:{maintainAspectRatio:false}});
    containerChartInstance = new Chart(ctx('containerChart'), {type:'bar', data:{labels:Object.keys(ctd).slice(0,8), datasets:[{label:'æ•°é‡',data:Object.values(ctd).slice(0,8), backgroundColor:'#007aff'}]}, options:{maintainAspectRatio:false}});
  }
});
document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>