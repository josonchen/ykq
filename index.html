<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#4A90E2" />
  <title>ğŸ  å®¶ç”¨ç‰©å“ç®¡å®¶</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
      background: #f9f9f9;
      color: #333;
      line-height: 1.6;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      max-width: 600px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      padding: 16px;
      background: #4A90E2;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .container { padding: 16px; }
    input, select, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }
    textarea { height: 60px; resize: vertical; }
    button {
      background: #4A90E2;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button.secondary { background: #6c757d; }
    button.danger { background: #dc3545; }
    button.mini {
      width: auto;
      padding: 6px 12px;
      font-size: 14px;
      margin-left: 8px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .location-path {
      color: #666;
      font-size: 14px;
      margin: 6px 0;
    }
    .item img { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; }
    .tabs {
      display: flex;
      margin: 16px 0;
      gap: 8px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
    }
    .tab.active { background: #4A90E2; color: white; }
    canvas { max-width: 100%; margin: 20px 0; }
    footer { text-align: center; padding: 16px; color: #888; font-size: 14px; }
    .hint {
      font-size: 13px;
      color: #888;
      margin-top: -6px;
      margin-bottom: 8px;
    }
    .form-group {
      margin: 8px 0;
    }
    .qr-content {
      margin-top: 8px;
      padding: 8px;
      background: #f0f8ff;
      border-radius: 6px;
      font-size: 14px;
      word-break: break-all;
    }
    .qr-content a {
      color: #4A90E2;
      text-decoration: underline;
    }
    .storage-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 8px;
      border-radius: 6px;
      margin: 10px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ  å®¶ç”¨ç‰©å“ç®¡å®¶</h1>
  </header>

  <div class="container">
    <!-- Tab åˆ‡æ¢ -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('manage')">ç®¡ç†</div>
      <div class="tab" onclick="switchTab('stats')">ğŸ“Š ç»Ÿè®¡</div>
    </div>

    <!-- ç®¡ç†é¢æ¿ -->
    <div id="managePanel">
      <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ç‰©å“åç§°æˆ–ä½ç½®..." />

      <!-- å­˜å‚¨ç©ºé—´æç¤ºï¼ˆä»…ç”¨äºå‹å¥½æç¤ºï¼‰ -->
      <div id="storageWarning" class="storage-warning" style="display:none;"></div>

      <!-- è¡¨å• -->
      <div id="itemForm">
        <input type="hidden" id="editId" />
        <input type="text" id="itemName" placeholder="ç‰©å“åç§°ï¼ˆå¿…å¡«ï¼‰" required />

        <div class="form-group">
          <label for="itemCategory">åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="itemCategory" list="categoryList" />
        </div>

        <div style="display:flex;align-items:center;">
          <select id="itemRoom" style="flex:1;"></select>
          <button type="button" class="mini" onclick="addNewRoom()">+ æ–°å»º</button>
        </div>

        <div style="display:flex;align-items:center;">
          <select id="itemContainer" style="flex:1;">
            <option value="">å®¹å™¨ï¼ˆå¦‚ï¼šè¡£æŸœã€å·¥å…·ç®±ï¼‰</option>
          </select>
          <button type="button" class="mini" onclick="addNewContainer()">+ æ–°å»º</button>
        </div>

        <input type="text" id="itemShelf" placeholder="å±‚/æ ¼ï¼ˆå¦‚ï¼šä¸Šå±‚ã€ç¬¬äºŒæ ¼ï¼‰" list="shelfList" />
        <textarea id="itemLocation" placeholder="å…·ä½“ä½ç½®æè¿°ï¼ˆå¦‚ï¼šå·¦ä¸Šè§’æŠ½å±‰å†…ï¼‰"></textarea>

        <div class="form-group">
          <label for="itemImage">ğŸ“¸ ç‰©å“ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
          <input type="file" id="itemImage" accept="image/*" capture="environment" />
          <div class="hint">ç³»ç»Ÿå°†è‡ªåŠ¨å‹ç¼©ä»¥èŠ‚çœç©ºé—´</div>
        </div>

        <div class="form-group">
          <label for="itemQrCode">ğŸ·ï¸ ä¸Šä¼ äºŒç»´ç å›¾ç‰‡</label>
          <input type="file" id="itemQrCode" accept="image/*" />
          <div class="hint">æ”¯æŒæœ€å¤§ 5MB å›¾ç‰‡ï¼Œè‡ªåŠ¨è¯†åˆ«å†…å®¹ï¼ˆä¸ä¿å­˜åŸå›¾ï¼‰</div>
        </div>

        <button id="saveBtn">â• æ·»åŠ ç‰©å“</button>
      </div>

      <!-- åŠŸèƒ½æŒ‰é’® -->
      <div style="display:flex;gap:8px;margin:16px 0;flex-wrap:wrap;">
        <button id="exportBtn" class="secondary">ğŸ“¤ å¯¼å‡ºåˆ° iCloud</button>
        <button id="importBtn" class="secondary">ğŸ“¥ ä» iCloud å¯¼å…¥</button>
        <button id="clearDataBtn" class="danger">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
      </div>

      <div id="itemsList"></div>
    </div>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div id="statsPanel" style="display:none;">
      <h3>ğŸ“¦ ç‰©å“æ€»æ•°ï¼š<span id="totalItems">0</span></h3>
      <h4>æŒ‰æˆ¿é—´åˆ†å¸ƒ</h4>
      <canvas id="roomChart"></canvas>
      <h4>æŒ‰åˆ†ç±»åˆ†å¸ƒ</h4>
      <canvas id="categoryChart"></canvas>
      <h4>æŒ‰å®¹å™¨åˆ†å¸ƒï¼ˆTop 5ï¼‰</h4>
      <canvas id="containerChart"></canvas>
    </div>
  </div>

  <datalist id="categoryList"></datalist>
  <datalist id="shelfList"></datalist>

  <footer>
    æ•°æ®ä¿å­˜åœ¨æœ¬æœº Â· äºŒç»´ç ä»…å­˜æ–‡æœ¬å†…å®¹ Â· å¯¼å‡º JSON å¯è·¨è®¾å¤‡åŒæ­¥
  </footer>

  <script>
    // ======================
    // å…¨å±€æ•°æ®
    // ======================
    let items = [];
    let recentRooms = ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];
    let recentContainers = ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];
    let recentShelves = ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];

    // ======================
    // åˆå§‹åŒ–æ•°æ®ï¼ˆä» localStorage åŠ è½½ï¼‰
    // ======================
    function loadDataFromStorage() {
      try {
        const savedItems = localStorage.getItem('homeItems_v4');
        if (savedItems) items = JSON.parse(savedItems);
        const rooms = localStorage.getItem('recentRooms');
        if (rooms) recentRooms = JSON.parse(rooms);
        const containers = localStorage.getItem('recentContainers');
        if (containers) recentContainers = JSON.parse(containers);
        const shelves = localStorage.getItem('recentShelves');
        if (shelves) recentShelves = JSON.parse(shelves);
      } catch (e) {
        console.warn('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼', e);
      }
    }

    // ======================
    // ã€âœ… ä¿®å¤ç‰ˆã€‘ç²¾ç¡®åˆ¤æ–­æ•°æ®æ˜¯å¦è¿‡å¤§ï¼ˆåŸºäº JSON å­—ç¬¦ä¸²çš„ UTF-8 å­—èŠ‚æ•°ï¼‰
    // ======================
    function isDataTooLarge(dataToSave, maxSizeBytes = 4_700_000) {
      try {
        const jsonString = JSON.stringify(dataToSave);
        // ä½¿ç”¨ TextEncoder è·å–çœŸå®å­—èŠ‚æ•°ï¼ˆUTF-8ï¼‰
        const byteLength = new TextEncoder().encode(jsonString).length;
        return byteLength > maxSizeBytes;
      } catch (e) {
        console.warn('åºåˆ—åŒ–æ•°æ®å¤±è´¥ï¼Œä¿å®ˆè®¤ä¸ºè¿‡å¤§', e);
        return true;
      }
    }

    // ======================
    // ã€âœ… ä¿®å¤ç‰ˆã€‘ä¿å­˜æ•°æ®ï¼ˆä»…æ£€æŸ¥å¾…ä¿å­˜æ•°æ®å¤§å°ï¼‰
    // ======================
    function saveData() {
      try {
        const dataToSave = { items, recentRooms, recentContainers, recentShelves };
        
        if (isDataTooLarge(dataToSave)) {
          alert('âš ï¸ æ•°æ®è¿‡å¤§ï¼ˆè¶…è¿‡ 4.7MBï¼‰ï¼\nè¯·åˆ é™¤éƒ¨åˆ†å¸¦å›¾ç‰©å“åå†ä¿å­˜ã€‚');
          return false;
        }

        localStorage.setItem('homeItems_v4', JSON.stringify(items));
        localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
        localStorage.setItem('recentContainers', JSON.stringify(recentContainers));
        localStorage.setItem('recentShelves', JSON.stringify(recentShelves));

        renderFormOptions();
        renderItems();
        renderStats();
        updateStorageWarning(); // æ›´æ–°æç¤ºï¼ˆä»… UIï¼‰
        return true;
      } catch (err) {
        if (err.name === 'QuotaExceededError') {
          alert('âš ï¸ æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ï¼\nå»ºè®®ï¼š\n1. ç‚¹å‡»â€œæ¸…ç©ºæ‰€æœ‰æ•°æ®â€\n2. é‡å¯æµè§ˆå™¨\n3. å†å¯¼å…¥å°æ–‡ä»¶');
        } else {
          alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + (err.message || err));
        }
        return false;
      }
    }

    // ======================
    // ã€âœ… ä¿®å¤ç‰ˆã€‘æ›´æ–°å­˜å‚¨æç¤ºï¼ˆä»…ç”¨äºæ˜¾ç¤ºå½“å‰æ•°æ®å¤§å°ï¼‰
    // ======================
    function updateStorageWarning() {
      try {
        const dataToSave = { items, recentRooms, recentContainers, recentShelves };
        const jsonString = JSON.stringify(dataToSave);
        const byteLength = new TextEncoder().encode(jsonString).length;
        const mb = (byteLength / 1024 / 1024).toFixed(2);
        
        const warningEl = document.getElementById('storageWarning');
        if (byteLength > 4_000_000) { // >4MB æ—¶æç¤º
          warningEl.innerHTML = `ğŸ’¡ å½“å‰æ•°æ®å¤§å°çº¦ ${mb} MB`;
          warningEl.style.display = 'block';
        } else {
          warningEl.style.display = 'none';
        }
      } catch (e) {
        document.getElementById('storageWarning').style.display = 'none';
      }
    }

    // ======================
    // ã€âœ… ä¿®å¤ç‰ˆã€‘å¼ºåˆ¶æ¸…ç©ºæ•°æ®
    // ======================
    function clearAllData() {
      if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰ç‰©å“å’Œè®¾ç½®ï¼\n\nè¯·ç¡®ä¿å·²å…ˆå¯¼å‡ºå¤‡ä»½ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
        return;
      }

      items = [];
      recentRooms = ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];
      recentContainers = ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];
      recentShelves = ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];

      localStorage.removeItem('homeItems_v4');
      localStorage.removeItem('recentRooms');
      localStorage.removeItem('recentContainers');
      localStorage.removeItem('recentShelves');

      // æ¸…ç†å¯èƒ½çš„æ®‹ç•™ key
      Object.keys(localStorage).forEach(key => {
        if (/home|item|room|container|shelf/i.test(key)) {
          localStorage.removeItem(key);
        }
      });

      renderFormOptions();
      renderItems();
      updateStorageWarning();
      alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
    }

    // ======================
    // ã€âœ… ä¿®å¤ç‰ˆã€‘å®‰å…¨å¯¼å…¥ï¼ˆå…ˆæ¸…å†…å­˜å†åŠ è½½ï¼‰
    // ======================
    function safeImportData(data) {
      try {
        // æ¸…ç©ºå½“å‰å†…å­˜
        items = [];
        recentRooms = [];
        recentContainers = [];
        recentShelves = [];

        // åŠ è½½æ–°æ•°æ®
        if (data.items) items = data.items;
        if (data.recentRooms) recentRooms = data.recentRooms;
        if (data.recentContainers) recentContainers = data.recentContainers;
        if (data.recentShelves) recentShelves = data.recentShelves;

        // å°è¯•ä¿å­˜ï¼ˆä½¿ç”¨æ–°åˆ¤æ–­é€»è¾‘ï¼‰
        if (!saveData()) {
          throw new Error('æ•°æ®è¿‡å¤§ï¼Œæ— æ³•ä¿å­˜');
        }

        alert('âœ… å®‰å…¨å¯¼å…¥æˆåŠŸï¼');
      } catch (err) {
        // å¯¼å…¥å¤±è´¥ï¼šä¿æŒç©ºçŠ¶æ€ï¼ˆä¸æ¢å¤é»˜è®¤å€¼ï¼‰
        items = [];
        recentRooms = [];
        recentContainers = [];
        recentShelves = [];
        alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + err.message);
      }
    }

    // ======================
    // åŸæœ‰åŠŸèƒ½ï¼ˆç•¥ä½œè°ƒæ•´ï¼‰
    // ======================
    async function compressImage(file, maxWidth = 400, quality = 0.65) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.src = url;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          let { width, height } = img;
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob(blob => {
            URL.revokeObjectURL(url);
            if (!blob) return reject(new Error('Canvas toBlob å¤±è´¥'));
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(new Error('è¯»å–å‹ç¼©å›¾åƒå¤±è´¥'));
            reader.readAsDataURL(blob);
          }, 'image/jpeg', quality);
        };
        img.onerror = () => {
          URL.revokeObjectURL(url);
          reject(new Error('åŠ è½½å›¾åƒå¤±è´¥'));
        };
      });
    }

    async function decodeQRFromFile(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.src = url;
        img.onload = () => {
          const MAX_DIMENSION = 1500;
          let { width, height } = img;
          if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
            const scale = Math.min(MAX_DIMENSION / width, MAX_DIMENSION / height);
            width = Math.floor(width * scale);
            height = Math.floor(height * scale);
          }
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          const imageData = ctx.getImageData(0, 0, width, height);
          URL.revokeObjectURL(url);
          try {
            const code = jsQR(imageData.data, width, height);
            if (code) resolve(code.data.trim());
            else reject(new Error('æœªæ£€æµ‹åˆ°æœ‰æ•ˆäºŒç»´ç ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”ä»…å«ä¸€ä¸ªäºŒç»´ç '));
          } catch (err) {
            reject(new Error('äºŒç»´ç è§£æå¤±è´¥ï¼š' + (err.message || err)));
          }
        };
        img.onerror = () => {
          URL.revokeObjectURL(url);
          reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
        };
      });
    }

    function uuid() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    function getLocationPath(item) {
      let path = item.room;
      if (item.container) path += ` > ${item.container}`;
      if (item.shelf_or_compartment) path += ` > ${item.shelf_or_compartment}`;
      return path;
    }

    function renderFormOptions() {
      const itemRoom = document.getElementById('itemRoom');
      const itemContainer = document.getElementById('itemContainer');
      const categoryList = document.getElementById('categoryList');
      const shelfList = document.getElementById('shelfList');

      itemRoom.innerHTML = '';
      recentRooms.forEach(room => {
        const opt = document.createElement('option');
        opt.value = room;
        opt.textContent = room;
        itemRoom.appendChild(opt);
      });

      itemContainer.innerHTML = '<option value="">å®¹å™¨ï¼ˆå¦‚ï¼šè¡£æŸœã€å·¥å…·ç®±ï¼‰</option>' +
        recentContainers.map(c => `<option value="${c}">${c}</option>`).join('');

      categoryList.innerHTML = '';
      [...new Set(items.map(i => i.category).filter(Boolean))].forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        categoryList.appendChild(opt);
      });

      shelfList.innerHTML = '';
      recentShelves.forEach(shelf => {
        const opt = document.createElement('option');
        opt.value = shelf;
        shelfList.appendChild(opt);
      });
    }

    function renderItems() {
      const searchInput = document.getElementById('searchInput');
      const itemsList = document.getElementById('itemsList');
      const term = searchInput.value.trim().toLowerCase();
      const filtered = items.filter(item =>
        item.name.toLowerCase().includes(term) ||
        getLocationPath(item).toLowerCase().includes(term) ||
        (item.specific_location && item.specific_location.toLowerCase().includes(term)) ||
        (item.qr_code && item.qr_code.toLowerCase().includes(term))
      );

      itemsList.innerHTML = filtered.length === 0
        ? '<p style="text-align:center;color:#888;">æš‚æ— ç‰©å“</p>'
        : filtered.map(item => {
            let qrDisplay = '';
            if (item.qr_code) {
              const isUrl = /^https?:\/\//.test(item.qr_code);
              qrDisplay = `
                <div class="qr-content">
                  <strong>ğŸ”— äºŒç»´ç å†…å®¹ï¼š</strong>
                  ${isUrl 
                    ? `<a href="${item.qr_code}" target="_blank" rel="noopener">${item.qr_code}</a>`
                    : `<span>${item.qr_code}</span>`
                  }
                </div>
              `;
            }

            return `
              <div class="item">
                <strong>${item.name}</strong>
                ${item.category ? `<br><small>ğŸ“‚ ${item.category}</small>` : ''}
                <div class="location-path">${getLocationPath(item)}</div>
                ${item.specific_location ? `<div>${item.specific_location}</div>` : ''}
                ${item.image ? `<img src="${item.image}" alt="${item.name}" style="max-height:100px;">` : ''}
                ${qrDisplay}
                <div style="margin-top:10px;">
                  <button class="secondary" style="padding:6px 10px;font-size:14px;" onclick="editItem('${item.id}')">âœï¸ ç¼–è¾‘</button>
                  <button class="secondary" style="padding:6px 10px;font-size:14px;" onclick="deleteItem('${item.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
              </div>
            `;
          }).join('');

      document.getElementById('totalItems').textContent = items.length;
    }

    function editItem(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;
      document.getElementById('editId').value = item.id;
      document.getElementById('itemName').value = item.name;
      document.getElementById('itemCategory').value = item.category || '';
      document.getElementById('itemRoom').value = item.room;
      document.getElementById('itemContainer').value = item.container || '';
      document.getElementById('itemShelf').value = item.shelf_or_compartment || '';
      document.getElementById('itemLocation').value = item.specific_location || '';
      document.getElementById('saveBtn').textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
      window.scrollTo(0, 0);
    }

    function deleteItem(id) {
      if (confirm('ç¡®å®šåˆ é™¤æ­¤ç‰©å“ï¼Ÿ')) {
        items = items.filter(item => item.id !== id);
        saveData();
      }
    }

    // ======================
    // äº‹ä»¶ç»‘å®š
    // ======================
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const itemName = document.getElementById('itemName');
      const itemRoom = document.getElementById('itemRoom');
      const name = itemName.value.trim();
      const room = itemRoom.value.trim();
      if (!name || !room) {
        alert('è¯·å¡«å†™ç‰©å“åç§°å’Œæˆ¿é—´');
        return;
      }

      const MAX_IMAGE_SIZE = 2 * 1024 * 1024;
      const MAX_QR_SIZE = 5 * 1024 * 1024;

      const itemImage = document.getElementById('itemImage');
      const itemQrCode = document.getElementById('itemQrCode');

      if (itemImage.files[0] && itemImage.files[0].size > MAX_IMAGE_SIZE) {
        alert('ğŸ“¸ ç‰©å“ç…§ç‰‡ä¸èƒ½è¶…è¿‡ 2MB');
        return;
      }
      if (itemQrCode.files[0] && itemQrCode.files[0].size > MAX_QR_SIZE) {
        alert('ğŸ·ï¸ äºŒç»´ç å›¾ç‰‡è¿‡å¤§ï¼ˆè¶…è¿‡ 5MBï¼‰\n\nğŸ’¡ å»ºè®®ï¼š\nâ€¢ æˆªå›¾åªåŒ…å«äºŒç»´ç åŒºåŸŸ\nâ€¢ ç”¨å¾®ä¿¡/QQè½¬å‘åä¿å­˜ï¼ˆè‡ªåŠ¨å‹ç¼©ï¼‰\nâ€¢ ä½¿ç”¨ç³»ç»Ÿç›¸å†Œç¼–è¾‘è£å‰ª');
        return;
      }

      const originalText = document.getElementById('saveBtn').textContent;
      document.getElementById('saveBtn').disabled = true;
      document.getElementById('saveBtn').textContent = 'â³ ä¿å­˜ä¸­...';

      try {
        let imageBase64 = '';
        let qrContent = '';

        if (itemImage.files[0]) imageBase64 = await compressImage(itemImage.files[0]);
        if (itemQrCode.files[0]) qrContent = await decodeQRFromFile(itemQrCode.files[0]);

        const newItem = {
          id: document.getElementById('editId').value || uuid(),
          name,
          category: document.getElementById('itemCategory').value.trim() || null,
          room,
          container: document.getElementById('itemContainer').value.trim() || null,
          shelf_or_compartment: document.getElementById('itemShelf').value.trim() || null,
          specific_location: document.getElementById('itemLocation').value.trim() || null,
          image: imageBase64,
          qr_code: qrContent,
          created_at: document.getElementById('editId').value 
            ? items.find(i => i.id === document.getElementById('editId').value)?.created_at 
            : new Date().toISOString()
        };

        if (document.getElementById('editId').value) {
          items = items.map(i => i.id === document.getElementById('editId').value ? newItem : i);
        } else {
          if (!recentRooms.includes(newItem.room)) recentRooms.unshift(newItem.room);
          if (newItem.container && !recentContainers.includes(newItem.container)) recentContainers.unshift(newItem.container);
          if (newItem.shelf_or_compartment && !recentShelves.includes(newItem.shelf_or_compartment)) recentShelves.unshift(newItem.shelf_or_compartment);
          recentRooms = recentRooms.slice(0, 20);
          recentContainers = recentContainers.slice(0, 20);
          recentShelves = recentShelves.slice(0, 20);
          items.push(newItem);
        }

        resetForm();
        if (!saveData()) {
          if (!document.getElementById('editId').value) items.pop();
          throw new Error('æ•°æ®è¿‡å¤§ï¼Œæ— æ³•ä¿å­˜');
        }
        alert(document.getElementById('editId').value ? 'âœ… ä¿®æ”¹æˆåŠŸï¼' : 'âœ… æ·»åŠ æˆåŠŸï¼');
      } catch (err) {
        console.error(err);
        alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + (err.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•'));
      } finally {
        document.getElementById('saveBtn').disabled = false;
        document.getElementById('saveBtn').textContent = originalText;
      }
    });

    function resetForm() {
      document.getElementById('editId').value = '';
      document.getElementById('itemName').value = '';
      document.getElementById('itemCategory').value = '';
      document.getElementById('itemShelf').value = '';
      document.getElementById('itemLocation').value = '';
      document.getElementById('itemImage').value = '';
      document.getElementById('itemQrCode').value = '';
      document.getElementById('saveBtn').textContent = 'â• æ·»åŠ ç‰©å“';
    }

    function addNewRoom() {
      const newRoom = prompt('è¯·è¾“å…¥æ–°æˆ¿é—´åç§°ï¼š');
      if (newRoom && newRoom.trim() && !recentRooms.includes(newRoom.trim())) {
        recentRooms.unshift(newRoom.trim());
        saveData();
      }
    }

    function addNewContainer() {
      const newContainer = prompt('è¯·è¾“å…¥æ–°å®¹å™¨åç§°ï¼š');
      if (newContainer && newContainer.trim() && !recentContainers.includes(newContainer.trim())) {
        recentContainers.unshift(newContainer.trim());
        saveData();
      }
    }

    document.getElementById('exportBtn').addEventListener('click', () => {
      if (items.length === 0) return alert('æ²¡æœ‰ç‰©å“å¯å¯¼å‡º');
      const blob = new Blob([JSON.stringify({ items, recentRooms, recentContainers, recentShelves }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `HomeItems_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('âœ… å¯¼å‡ºæˆåŠŸï¼\nè¯·ä¿å­˜åˆ° iCloud Drive ä»¥è·¨è®¾å¤‡åŒæ­¥ã€‚');
      }, 100);
    });

    // ã€âœ… ä¿®å¤ç‰ˆã€‘å®‰å…¨å¯¼å…¥æµç¨‹
    let importFile = document.createElement('input');
    importFile.type = 'file';
    importFile.accept = '.json';
    importFile.style.display = 'none';
    importFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data.items) throw new Error('æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ items å­—æ®µ');
          
          if (!confirm(`å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼ˆå…± ${data.items.length} é¡¹ï¼‰ï¼Œç¡®å®šå¯¼å…¥ï¼Ÿ`)) return;
          
          safeImportData(data);
        } catch (err) {
          alert('å¯¼å…¥å¤±è´¥ï¼š' + (err.message || 'æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®'));
        }
      };
      reader.readAsText(file);
      importFile.value = '';
    });
    document.body.appendChild(importFile);
    document.getElementById('importBtn').addEventListener('click', () => importFile.click());

    // ã€âœ… ä¿®å¤ç‰ˆã€‘æ¸…ç©ºæ•°æ®æŒ‰é’®
    document.getElementById('clearDataBtn').addEventListener('click', clearAllData);

    // ======================
    // ç»Ÿè®¡ & Tab
    // ======================
    let roomChart, categoryChart, containerChart;

    function renderStats() {
      const ctx1 = document.getElementById('roomChart').getContext('2d');
      const ctx2 = document.getElementById('categoryChart').getContext('2d');
      const ctx3 = document.getElementById('containerChart').getContext('2d');

      const roomCount = {};
      items.forEach(i => { roomCount[i.room] = (roomCount[i.room] || 0) + 1; });
      const roomLabels = Object.keys(roomCount);
      const roomData = Object.values(roomCount);

      const catCount = {};
      items.filter(i => i.category).forEach(i => { catCount[i.category] = (catCount[i.category] || 0) + 1; });
      const catLabels = Object.keys(catCount);
      const catData = Object.values(catCount);

      const contCount = {};
      items.filter(i => i.container).forEach(i => { contCount[i.container] = (contCount[i.container] || 0) + 1; });
      const sortedCont = Object.entries(contCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const contLabels = sortedCont.map(x => x[0]);
      const contData = sortedCont.map(x => x[1]);

      if (roomChart) roomChart.destroy();
      if (categoryChart) categoryChart.destroy();
      if (containerChart) containerChart.destroy();

      roomChart = new Chart(ctx1, {
        type: 'bar',
        data: { labels: roomLabels, datasets: [{ label: 'ç‰©å“æ•°é‡', data: roomData, backgroundColor: '#4A90E2' }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      categoryChart = new Chart(ctx2, {
        type: 'pie',
        data: { labels: catLabels, datasets: [{ data: catData, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }] },
        options: { responsive: true }
      });

      containerChart = new Chart(ctx3, {
        type: 'bar',
        data: { labels: contLabels, datasets: [{ label: 'ç‰©å“æ•°é‡', data: contData, backgroundColor: '#FF9F40' }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      if (tab === 'manage') {
        document.getElementById('managePanel').style.display = 'block';
        document.getElementById('statsPanel').style.display = 'none';
      } else {
        document.getElementById('managePanel').style.display = 'none';
        document.getElementById('statsPanel').style.display = 'block';
        renderStats();
      }
    }

    // ======================
    // åˆå§‹åŒ–
    // ======================
    loadDataFromStorage();
    document.getElementById('searchInput').addEventListener('input', renderItems);
    renderFormOptions();
    renderItems();
    updateStorageWarning(); // æ˜¾ç¤ºåˆå§‹æ•°æ®å¤§å°

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>