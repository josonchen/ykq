<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ğŸ  å®¶åº­ç‰©å“ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    /* === åŸºç¡€é‡ç½® === */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
    body { padding: 12px; background: #f2f2f7; color: #1c1c1e; line-height: 1.5; padding-bottom: 40px; }
    
    /* === æ ‡é¢˜ä¸ Tab === */
    h1 { text-align: center; margin: 12px 0 20px; font-size: 20px; font-weight: 600; color: #000; }
    .tab-bar { display: flex; margin-bottom: 16px; background: #e5e5ea; border-radius: 10px; padding: 2px; }
    .tab { flex: 1; padding: 8px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 14px; color: #8e8e93; transition: all 0.2s; }
    .tab.active { background: #fff; color: #007aff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: 500; }
    
    .panel { display: none; animation: fadeIn 0.3s ease; }
    #managePanel { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* === è¡¨å•å…ƒç´  === */
    label { display: block; font-weight: 600; margin-top: 14px; margin-bottom: 6px; color: #333; font-size: 14px; }
    input, select, textarea { 
      width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; background: #fff; appearance: none;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #007aff; }
    
    textarea { resize: vertical; min-height: 60px; }
    
    button { 
      width: 100%; background: #007aff; color: white; border: none; cursor: pointer; padding: 14px; 
      border-radius: 12px; font-size: 16px; font-weight: 500; margin-top: 10px; 
      active: scale(0.98); transition: transform 0.1s;
    }
    button:active { transform: scale(0.98); opacity: 0.9; }
    button.secondary { background: #e5e5ea; color: #007aff; }
    button.danger { background: #ff3b30; color: white; }
    button.warning { background: #ff9500; color: white; }
    button:disabled { opacity: 0.5; cursor: not-allowed; background: #ccc; color: #666; }

    .input-group { display: flex; gap: 8px; align-items: flex-start; }
    .input-group input, .input-group select { flex: 1; }
    .input-group button { width: auto; margin-top: 0; padding: 12px; white-space: nowrap; }

    /* OCR æŒ‰é’®æ ·å¼ */
    #ocrBtn { background: #34c759; color: white; padding: 0 16px; display: flex; align-items: center; justify-content: center; }

    /* === ç‰©å“åˆ—è¡¨å¸ƒå±€ === */
    #itemsList { margin-top: 20px; }
    .item { 
      background: white; 
      padding: 12px; 
      margin-bottom: 12px; 
      border-radius: 12px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
    }
    
    .item-header { 
      display: flex; justify-content: space-between; align-items: center; 
      border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; margin-bottom: 8px;
    }
    .item-name { font-weight: 600; font-size: 17px; color: #000; }
    .quantity-badge { background: #e3f2fd; color: #007aff; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }

    .item-body { display: flex; justify-content: space-between; gap: 12px; }
    .item-info { flex: 1; min-width: 0; }
    
    .info-row { font-size: 13px; color: #666; margin-bottom: 4px; line-height: 1.4; display: flex; align-items: baseline; }
    .info-row strong { color: #333; margin-right: 4px; white-space: nowrap; }
    
    .item-thumb {
      width: 80px; height: 80px; 
      object-fit: cover; 
      border-radius: 8px; 
      border: 1px solid #eee;
      flex-shrink: 0;
      background-color: #f9f9f9;
    }
    
    .item-actions { margin-top: 12px; display: flex; gap: 10px; }
    .item-actions button { margin-top: 0; padding: 8px; font-size: 13px; border-radius: 8px; background: #f2f2f7; color: #333; }
    .item-actions button.edit-btn { color: #007aff; }
    .item-actions button.delete-btn { color: #ff3b30; }

    /* === å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ === */
    #photoUploadArea {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; border: 2px dashed #d1d1d6; border-radius: 12px;
      background: #fafafa; color: #8e8e93; cursor: pointer; margin-top: 10px;
    }
    #photoPreviewInForm {
      max-width: 100%; max-height: 200px; 
      margin-top: 12px; border-radius: 8px; 
      display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* === ç»Ÿè®¡å›¾è¡¨ === */
    .chart-container { position: relative; height: 220px; margin: 20px 0; width: 100%; background: #fff; padding: 10px; border-radius: 12px; }

    /* === Modal === */
    #customModal {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center;
      backdrop-filter: blur(2px);
    }
    #modalContent { background: white; padding: 24px; border-radius: 16px; width: 85%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    #modalTitle { font-weight: 600; font-size: 18px; margin-bottom: 16px; text-align: center; }
    .modal-buttons { display: flex; gap: 12px; margin-top: 20px; }
    
    /* Loading é®ç½© */
    #loadingMask {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8); z-index: 2000; 
      flex-direction: column; align-items: center; justify-content: center;
    }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007aff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;}
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<h1>ğŸ  å®¶åº­ç‰©å“ç®¡ç†</h1>

<div class="tab-bar">
  <div class="tab active" data-tab="manage">ğŸ“¦ ç‰©å“ç®¡ç†</div>
  <div class="tab" data-tab="stats">ğŸ“Š æ•°æ®ç»Ÿè®¡</div>
</div>

<div id="managePanel" class="panel">

  <label>ç‰©å“åŸºæœ¬ä¿¡æ¯</label>
  <div class="input-group">
    <button type="button" id="ocrBtn">ğŸ“· æ‹å­—</button>
    <input type="text" id="itemName" placeholder="ç‰©å“åç§° (å¯æ‹ç…§è¯†åˆ«)" />
    <input type="number" id="itemQuantity" style="width: 70px; flex:none;" placeholder="æ•°é‡" value="1" min="1" inputmode="numeric" />
  </div>
  <div style="font-size:12px; color:#888; margin-top:4px;">ğŸ’¡ ç‚¹å‡»â€œæ‹å­—â€æ‹æ‘„åŒ…è£…ç›’æ–‡å­—ï¼Œè‡ªåŠ¨å¡«å…¥åç§°</div>
  <input type="file" id="ocrInput" accept="image/*" style="display:none;" />

  <label>å­˜æ”¾ä½ç½®</label>
  <div class="input-group">
    <select id="itemRoom"><option value="">é€‰æ‹©æˆ¿é—´</option></select>
    <button type="button" class="secondary" id="addRoomBtn">â•</button>
  </div>
  
  <div class="input-group" style="margin-top: 8px;">
    <input type="text" id="itemContainer" placeholder="å®¹å™¨ (å¦‚: æŠ½å±‰ã€ç®±å­)" list="containerList" />
    <datalist id="containerList"></datalist>
    <button type="button" class="secondary" id="addContainerBtn">â•</button>
  </div>

  <div class="input-group" style="margin-top: 8px;">
    <input type="text" id="itemShelf" placeholder="å…·ä½“å±‚/æ ¼ (å¯é€‰)" list="shelfList" />
    <datalist id="shelfList"></datalist>
  </div>

  <label>è¯¦ç»†æè¿°/åˆ†ç±»</label>
  <input type="text" id="itemCategory" placeholder="åˆ†ç±» (å¦‚: å·¥å…·ã€æ•°ç )" list="categoryList" style="margin-bottom:8px;" />
  <datalist id="categoryList"></datalist>
  <textarea id="itemLocation" placeholder="å¤‡æ³¨æˆ–æ›´å…·ä½“çš„ä½ç½®æè¿°..."></textarea>

  <label>ç‰©å“ç…§ç‰‡</label>
  <div id="photoUploadArea">
    <span>ğŸ“¸ ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©ç…§ç‰‡</span>
    <img id="photoPreviewInForm" src="" alt="é¢„è§ˆ" />
  </div>
  <input type="file" id="itemImage" accept="image/*" style="display:none;" />

  <input type="hidden" id="editId" value="" />
  <button id="saveBtn">â• æ·»åŠ ç‰©å“</button>

  <hr style="margin: 24px 0; border: 0; border-top: 1px solid #e0e0e0;" />

  <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢åç§°ã€ä½ç½®..." style="background:#fff url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23999\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><circle cx=\'11\' cy=\'11\' r=\'8\'></circle><line x1=\'21\' y1=\'21\' x2=\'16.65\' y2=\'16.65\'></line></svg>') no-repeat 12px center; padding-left: 36px;" />
  
  <div id="itemsList"></div>
  
  <p style="text-align:center; margin:16px 0; color:#8e8e93; font-size:13px;">
    å…± <span id="totalItems">0</span> é¡¹ â€¢ æ€»è®¡ <span id="totalQuantity">0</span> ä¸ª
  </p>

  <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
    <button id="exportBtn" class="secondary">ğŸ“¤ å¤‡ä»½</button>
    <button id="importBtn" class="warning">ğŸ“¥ æ¢å¤</button>
    <button id="clearDataBtn" class="danger">ğŸ—‘ï¸ æ¸…ç©º</button>
  </div>
</div>

<div id="statsPanel" class="panel">
  <div class="chart-container"><canvas id="roomChart"></canvas></div>
  <div class="chart-container"><canvas id="categoryChart"></canvas></div>
  <div class="chart-container"><canvas id="containerChart"></canvas></div>
</div>

<div id="customModal">
  <div id="modalContent">
    <div id="modalTitle">æ–°å¢é€‰é¡¹</div>
    <input type="text" id="modalInput" placeholder="è¯·è¾“å…¥åç§°" maxlength="20" />
    <div class="modal-buttons">
      <button id="modalCancelBtn" class="secondary">å–æ¶ˆ</button>
      <button id="modalConfirmBtn">ç¡®å®š</button>
    </div>
  </div>
</div>

<div id="loadingMask">
  <div class="spinner"></div>
  <div id="loadingText">å¤„ç†ä¸­...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
// === Service Worker æ³¨å†Œ ===
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('SW Registered'))
    .catch(err => console.log('SW Failed', err));
}

// === IndexedDB å°è£… (è§£å†³å­˜å‚¨æ»¡é—®é¢˜) ===
const DB_NAME = 'HomeItemsDB';
const DB_VERSION = 1;
const STORE_NAME = 'items';

const db = {
  open: () => {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onupgradeneeded = (e) => {
        const database = e.target.result;
        if (!database.objectStoreNames.contains(STORE_NAME)) {
          database.createObjectStore(STORE_NAME, { keyPath: 'id' });
        }
      };
      request.onsuccess = (e) => resolve(e.target.result);
      request.onerror = (e) => reject(e);
    });
  },
  getAll: async () => {
    const database = await db.open();
    return new Promise((resolve, reject) => {
      const tx = database.transaction(STORE_NAME, 'readonly');
      const store = tx.objectStore(STORE_NAME);
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result || []);
      request.onerror = () => reject(request.error);
    });
  },
  put: async (item) => {
    const database = await db.open();
    return new Promise((resolve, reject) => {
      const tx = database.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      const request = store.put(item);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  },
  delete: async (id) => {
    const database = await db.open();
    return new Promise((resolve, reject) => {
      const tx = database.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      const request = store.delete(id);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  },
  clear: async () => {
    const database = await db.open();
    return new Promise((resolve, reject) => {
      const tx = database.transaction(STORE_NAME, 'readwrite');
      const store = tx.objectStore(STORE_NAME);
      const request = store.clear();
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }
};

// === å…¨å±€å˜é‡ ===
let items = [];
let recentRooms = ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];
let recentContainers = ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];
let recentShelves = ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];

let roomChartInstance, categoryChartInstance, containerChartInstance;
let userSelectedNewImage = false;
let pendingItemImageBase64 = '';
let isImageProcessing = false;

// === æ ¸å¿ƒåŠŸèƒ½ ===

// 1. æ•°æ®åŠ è½½ä¸è¿ç§» (LocalStorage -> IndexedDB)
async function loadData() {
  showLoading('åŠ è½½æ•°æ®...');
  try {
    // åŠ è½½è¾…åŠ©é…ç½® (ä»ä¿ç•™åœ¨ LocalStorage)
    if(localStorage.getItem('recentRooms')) recentRooms = JSON.parse(localStorage.getItem('recentRooms'));
    if(localStorage.getItem('recentContainers')) recentContainers = JSON.parse(localStorage.getItem('recentContainers'));
    if(localStorage.getItem('recentShelves')) recentShelves = JSON.parse(localStorage.getItem('recentShelves'));

    // å°è¯•ä» IndexedDB åŠ è½½ç‰©å“
    items = await db.getAll();

    // â¬‡ï¸ è¿ç§»é€»è¾‘ï¼šå¦‚æœ IDB ä¸ºç©ºï¼Œä½† LocalStorage æœ‰æ•°æ®ï¼Œåˆ™è¿ç§»
    if (items.length === 0) {
      const oldData = localStorage.getItem('homeItems_v5');
      if (oldData) {
        console.log('æ£€æµ‹åˆ°æ—§æ•°æ®ï¼Œæ­£åœ¨è¿ç§»åˆ° IndexedDB...');
        const oldItems = JSON.parse(oldData);
        if (Array.isArray(oldItems) && oldItems.length > 0) {
          for (const item of oldItems) {
            await db.put(item);
          }
          items = oldItems;
          // è¿ç§»æˆåŠŸåæ¸…é™¤æ—§æ•°æ®ï¼Œé‡Šæ”¾ LocalStorage
          localStorage.removeItem('homeItems_v5'); 
          alert('ğŸ‰ ç³»ç»Ÿå‡çº§æˆåŠŸï¼æ•°æ®å·²è¿ç§»è‡³å¤§å®¹é‡å­˜å‚¨åº“ã€‚');
        }
      }
    }
  } catch (e) {
    console.error('åŠ è½½å¤±è´¥', e);
    alert('æ•°æ®åŠ è½½å‡ºé”™ï¼Œè¯·è”ç³»å¼€å‘è€…');
  } finally {
    hideLoading();
    renderItems();
    renderOptions();
  }
}

// 2. æ¸²æŸ“è¡¨å•é€‰é¡¹
function renderOptions(currentItem = null) {
  const roomSel = document.getElementById('itemRoom');
  const contDL = document.getElementById('containerList');
  const catDL = document.getElementById('categoryList');
  const shelfDL = document.getElementById('shelfList');

  const roomsToShow = [...new Set([...recentRooms, ...(currentItem?.room ? [currentItem.room] : [])])];
  roomSel.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ¿é—´</option>' + 
    roomsToShow.map(r => `<option value="${r}">${r}</option>`).join('');

  const contsToShow = [...new Set([...recentContainers, ...(currentItem?.container ? [currentItem.container] : [])])];
  contDL.innerHTML = contsToShow.map(c => `<option value="${c}">`).join('');

  const cats = [...new Set(items.map(i => i.category).filter(Boolean))];
  catDL.innerHTML = cats.map(c => `<option value="${c}">`).join('');

  shelfDL.innerHTML = recentShelves.map(s => `<option value="${s}">`).join('');
}

// 3. æ¸²æŸ“åˆ—è¡¨
function renderItems() {
  const term = document.getElementById('searchInput').value.trim().toLowerCase();
  const listEl = document.getElementById('itemsList');
  
  // æŒ‰ç…§ä¿®æ”¹æ—¶é—´å€’åºæ’åˆ— (å¯é€‰)
  const sortedItems = [...items].reverse();

  const filtered = sortedItems.filter(item => {
    const fullText = `${item.name} ${item.room} ${item.container || ''} ${item.shelf || ''} ${item.specific_location || ''}`.toLowerCase();
    return fullText.includes(term);
  });

  if (filtered.length === 0) {
    listEl.innerHTML = '<div style="text-align:center;padding:40px;color:#ccc;">æš‚æ— åŒ¹é…ç‰©å“</div>';
  } else {
    listEl.innerHTML = filtered.map(item => {
      let path = item.room;
      if (item.container) path += ` > ${item.container}`;
      if (item.shelf) path += ` > ${item.shelf}`;

      return `
      <div class="item" data-id="${item.id}">
        <div class="item-header">
          <span class="item-name">${item.name}</span>
          ${item.quantity > 1 ? `<span class="quantity-badge">Ã—${item.quantity}</span>` : ''}
        </div>
        
        <div class="item-body">
          <div class="item-info">
            <div class="info-row"><strong>ğŸ“</strong> ${path}</div>
            ${item.category ? `<div class="info-row"><strong>ğŸ“‚</strong> ${item.category}</div>` : ''}
            ${item.specific_location ? `<div class="info-row" style="color:#888;">ğŸ“ ${item.specific_location}</div>` : ''}
          </div>
          
          ${item.image 
            ? `<img class="item-thumb" src="${item.image}" onclick="viewImage('${item.id}')" alt="å›¾">` 
            : '<div style="width:0;"></div>' 
          }
        </div>

        <div class="item-actions">
          <button class="edit-btn">âœï¸ ç¼–è¾‘</button>
          <button class="delete-btn">ğŸ—‘ï¸ åˆ é™¤</button>
        </div>
      </div>
      `;
    }).join('');
  }
  
  document.getElementById('totalItems').textContent = items.length;
  document.getElementById('totalQuantity').textContent = items.reduce((a,b) => a + (parseInt(b.quantity)||1), 0);
}

window.viewImage = (id) => {
  const item = items.find(i => i.id === id);
  if(item && item.image) {
    const w = window.open("");
    w.document.write(`<img src="${item.image}" style="width:100%;" />`);
  }
};

// 4. å›¾ç‰‡å‹ç¼©
function compressImage(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const maxWidth = 800; 
        let w = img.width, h = img.height;
        if (w > maxWidth) { h = (h * maxWidth) / w; w = maxWidth; }
        
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', 0.6));
      };
    };
  });
}

// === OCR æ–‡å­—è¯†åˆ«é€»è¾‘ ===
document.getElementById('ocrBtn').addEventListener('click', () => {
  document.getElementById('ocrInput').click();
});

document.getElementById('ocrInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  showLoading('æ­£åœ¨è¯†åˆ«æ–‡å­—...\né¦–æ¬¡å¯èƒ½è¾ƒæ…¢');
  
  try {
    // è¯†åˆ«ä¸­è‹±æ–‡
    const worker = await Tesseract.createWorker('chi_sim+eng');
    const ret = await worker.recognize(file);
    await worker.terminate();

    const text = ret.data.text.replace(/\s+/g, ' ').trim();
    if (text) {
      // ç®€å•æˆªå–å‰20ä¸ªå­—ç¬¦é˜²æ­¢è¯†åˆ«å¤§æ®µæ–‡å­—
      const cleanText = text.substring(0, 30); 
      document.getElementById('itemName').value = cleanText;
    } else {
      alert('æœªè¯†åˆ«åˆ°æ˜æ˜¾æ–‡å­—ï¼Œè¯·é‡è¯•');
    }
  } catch (err) {
    console.error(err);
    alert('è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•');
  } finally {
    hideLoading();
    document.getElementById('ocrInput').value = ''; // é‡ç½®ä»¥ä¾¿å†æ¬¡è§¦å‘
  }
});


// === ä¿å­˜/ç¼–è¾‘/åˆ é™¤ ===
document.getElementById('saveBtn').addEventListener('click', async () => {
  if (isImageProcessing) { alert('æ­£åœ¨å¤„ç†å›¾ç‰‡ï¼Œè¯·ç¨å€™...'); return; }

  const name = document.getElementById('itemName').value.trim();
  const room = document.getElementById('itemRoom').value;
  
  if (!name) return alert('è¯·è¾“å…¥ç‰©å“åç§°');
  if (!room) return alert('è¯·é€‰æ‹©æˆ¿é—´');

  const editId = document.getElementById('editId').value;
  const oldItem = editId ? items.find(i => i.id === editId) : null;

  let finalImage = '';
  if (userSelectedNewImage && pendingItemImageBase64) {
    finalImage = pendingItemImageBase64;
  } else if (oldItem) {
    finalImage = oldItem.image || '';
  }

  const newItem = {
    id: editId || Date.now().toString(36),
    name,
    quantity: parseInt(document.getElementById('itemQuantity').value) || 1,
    room,
    container: document.getElementById('itemContainer').value.trim(),
    shelf: document.getElementById('itemShelf').value.trim(),
    category: document.getElementById('itemCategory').value.trim(),
    specific_location: document.getElementById('itemLocation').value.trim(),
    image: finalImage,
    updatedAt: Date.now() // è®°å½•æ—¶é—´
  };

  // ä¿å­˜åˆ° IndexedDB
  try {
    await db.put(newItem);
    
    // æ›´æ–°å†…å­˜ä¸­çš„æ•°ç»„
    if (editId) {
      const idx = items.findIndex(i => i.id === editId);
      if (idx > -1) items[idx] = newItem;
    } else {
      items.push(newItem);
    }
    
    // ä¿å­˜è¾…åŠ©é…ç½®åˆ° LocalStorage (è½»é‡æ•°æ®)
    localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
    localStorage.setItem('recentContainers', JSON.stringify(recentContainers));
    localStorage.setItem('recentShelves', JSON.stringify(recentShelves));

    resetForm();
    renderItems();
    alert(editId ? 'âœ… ä¿®æ”¹æˆåŠŸ' : 'âœ… æ·»åŠ æˆåŠŸ');
  } catch(e) {
    console.error(e);
    alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + e.message);
  }
});

// åˆ—è¡¨ç‚¹å‡»ä»£ç†
document.getElementById('itemsList').addEventListener('click', async (e) => {
  if (e.target.classList.contains('edit-btn')) {
    const id = e.target.closest('.item').dataset.id;
    const item = items.find(i => i.id === id);
    if (!item) return;

    document.getElementById('editId').value = item.id;
    document.getElementById('itemName').value = item.name;
    document.getElementById('itemQuantity').value = item.quantity;
    document.getElementById('itemCategory').value = item.category || '';
    document.getElementById('itemShelf').value = item.shelf || '';
    document.getElementById('itemLocation').value = item.specific_location || '';
    document.getElementById('itemContainer').value = item.container || '';
    
    if (!recentRooms.includes(item.room)) recentRooms.push(item.room);
    renderOptions(item);
    document.getElementById('itemRoom').value = item.room;

    const prev = document.getElementById('photoPreviewInForm');
    if (item.image) {
      prev.src = item.image;
      prev.style.display = 'block';
    } else {
      prev.style.display = 'none';
      prev.src = '';
    }

    userSelectedNewImage = false;
    pendingItemImageBase64 = '';
    document.getElementById('itemImage').value = ''; 

    document.getElementById('saveBtn').textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  if (e.target.classList.contains('delete-btn')) {
    if (confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
      const id = e.target.closest('.item').dataset.id;
      try {
        await db.delete(id);
        items = items.filter(i => i.id !== id);
        renderItems();
      } catch(e) {
        alert('åˆ é™¤å¤±è´¥');
      }
    }
  }
});

// å›¾ç‰‡é€‰æ‹©ç›‘å¬
document.getElementById('itemImage').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  const prev = document.getElementById('photoPreviewInForm');
  if (!file) return;

  prev.src = URL.createObjectURL(file);
  prev.style.display = 'block';
  
  isImageProcessing = true;
  document.getElementById('saveBtn').disabled = true;
  document.getElementById('saveBtn').textContent = 'å›¾ç‰‡å¤„ç†ä¸­...';

  try {
    pendingItemImageBase64 = await compressImage(file);
    userSelectedNewImage = true;
  } catch (err) {
    alert('å›¾ç‰‡å¤„ç†å¤±è´¥');
    userSelectedNewImage = false;
  } finally {
    isImageProcessing = false;
    document.getElementById('saveBtn').disabled = false;
    const isEdit = document.getElementById('editId').value;
    document.getElementById('saveBtn').textContent = isEdit ? 'ğŸ’¾ ä¿å­˜ä¿®æ”¹' : 'â• æ·»åŠ ç‰©å“';
  }
});

// è¾…åŠ©åŠŸèƒ½
function resetForm() {
  document.getElementById('editId').value = '';
  document.getElementById('itemName').value = '';
  document.getElementById('itemQuantity').value = 1;
  document.getElementById('itemRoom').value = '';
  document.getElementById('itemContainer').value = '';
  document.getElementById('itemShelf').value = '';
  document.getElementById('itemCategory').value = '';
  document.getElementById('itemLocation').value = '';
  document.getElementById('itemImage').value = ''; 
  
  document.getElementById('photoPreviewInForm').style.display = 'none';
  document.getElementById('photoPreviewInForm').src = '';
  
  document.getElementById('saveBtn').textContent = 'â• æ·»åŠ ç‰©å“';
  userSelectedNewImage = false;
  pendingItemImageBase64 = '';
}

function showLoading(text) {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loadingMask').style.display = 'flex';
}
function hideLoading() {
  document.getElementById('loadingMask').style.display = 'none';
}

// Modal é€»è¾‘
let modalType = '';
document.getElementById('addRoomBtn').onclick = () => showModal('room');
document.getElementById('addContainerBtn').onclick = () => showModal('container');

function showModal(type) {
  modalType = type;
  document.getElementById('modalTitle').innerText = type === 'room' ? 'æ–°å¢æˆ¿é—´' : 'æ–°å¢å®¹å™¨';
  document.getElementById('customModal').style.display = 'flex';
  document.getElementById('modalInput').focus();
}

document.getElementById('modalConfirmBtn').onclick = () => {
  const val = document.getElementById('modalInput').value.trim();
  if(val) {
    if(modalType === 'room' && !recentRooms.includes(val)) recentRooms.push(val);
    if(modalType === 'container' && !recentContainers.includes(val)) recentContainers.push(val);
    renderOptions();
    localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
    localStorage.setItem('recentContainers', JSON.stringify(recentContainers));
  }
  document.getElementById('customModal').style.display = 'none';
  document.getElementById('modalInput').value = '';
};

document.getElementById('modalCancelBtn').onclick = () => {
  document.getElementById('customModal').style.display = 'none';
};

// å¯¼å‡ºåŠŸèƒ½
document.getElementById('exportBtn').onclick = () => {
  const blob = new Blob([JSON.stringify({items, recentRooms, recentContainers, recentShelves},null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `å®¶åº­ç‰©å“å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
};

// å¯¼å…¥åŠŸèƒ½
document.getElementById('importBtn').onclick = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.onchange = async (e) => {
    const text = await e.target.files[0].text();
    showLoading('æ­£åœ¨å¯¼å…¥...');
    try {
      const data = JSON.parse(text);
      if(data.items) {
        // æ¸…ç©ºç°æœ‰åº“å¹¶å†™å…¥æ–°æ•°æ®
        await db.clear();
        for (const item of data.items) {
          await db.put(item);
        }
      }
      if(data.recentRooms) localStorage.setItem('recentRooms', JSON.stringify(data.recentRooms));
      if(data.recentContainers) localStorage.setItem('recentContainers', JSON.stringify(data.recentContainers));
      
      await loadData(); // é‡æ–°åŠ è½½
      alert('âœ… å¯¼å…¥æˆåŠŸ');
    } catch(err) { alert('âŒ æ ¼å¼é”™è¯¯'); }
    finally { hideLoading(); }
  };
  input.click();
};

document.getElementById('clearDataBtn').onclick = async () => {
  if(confirm('âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿä¸å¯æ¢å¤ï¼')) {
    await db.clear();
    items = [];
    renderItems();
  }
};

// Tab åˆ‡æ¢
document.querySelectorAll('.tab').forEach(t => t.onclick = function() {
  document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
  this.classList.add('active');
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.getElementById(this.dataset.tab + 'Panel').style.display = 'block';
  if (this.dataset.tab === 'stats') renderCharts();
});

// å›¾è¡¨æ¸²æŸ“
function renderCharts() {
  const ctx1 = document.getElementById('roomChart').getContext('2d');
  const ctx2 = document.getElementById('categoryChart').getContext('2d');
  const ctx3 = document.getElementById('containerChart').getContext('2d');
  
  if(roomChartInstance) roomChartInstance.destroy();
  if(categoryChartInstance) categoryChartInstance.destroy();
  if(containerChartInstance) containerChartInstance.destroy();

  const roomData = {}; items.forEach(i => roomData[i.room] = (roomData[i.room]||0)+1);
  const catData = {}; items.forEach(i => {if(i.category) catData[i.category] = (catData[i.category]||0)+1});
  const contData = {}; items.forEach(i => {if(i.container) contData[i.container] = (contData[i.container]||0)+1});

  roomChartInstance = new Chart(ctx1, { type: 'pie', data: { labels: Object.keys(roomData), datasets: [{ data: Object.values(roomData), backgroundColor: ['#007aff','#34c759','#ff9500','#ff3b30','#af52de'] }] }, options: { maintainAspectRatio:false } });
  categoryChartInstance = new Chart(ctx2, { type: 'doughnut', data: { labels: Object.keys(catData), datasets: [{ data: Object.values(catData), backgroundColor: ['#5ac8fa','#ffcc00','#ff2d55','#5856d6'] }] }, options: { maintainAspectRatio:false } });
  containerChartInstance = new Chart(ctx3, { type: 'bar', data: { labels: Object.keys(contData).slice(0,8), datasets: [{ label: 'æ•°é‡', data: Object.values(contData).slice(0,8), backgroundColor: '#007aff' }] }, options: { maintainAspectRatio:false } });
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  document.getElementById('photoUploadArea').addEventListener('click', () => {
    document.getElementById('itemImage').click();
  });
});
</script>
</body>
</html>