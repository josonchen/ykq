<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ğŸ  ç‰©å“ç®¡ç†ç³»ç»Ÿä¸€å£æ¸…</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { padding: 12px; background: #f9f9f9; color: #333; line-height: 1.5; }
    h1 { text-align: center; margin: 12px 0; font-size: 22px; }
    .tab-bar { display: flex; margin: 12px 0; gap: 6px; }
    .tab { flex: 1; padding: 10px; background: #e0e0e0; text-align: center; border-radius: 6px; cursor: pointer; font-size: 15px; }
    .tab.active { background: #4A90E2; color: white; }
    .panel { display: none; }
    #managePanel { display: block; }
    input, select, button, textarea { width: 100%; padding: 10px; margin: 6px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    label { display: block; font-weight: bold; margin-top: 10px; color: #444; font-size: 15px; }
    input[type="number"] { 
      -moz-appearance: textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    button { background: #4A90E2; color: white; border: none; cursor: pointer; padding: 10px; }
    button.secondary { background: #666; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #itemsList { margin-top: 16px; }
    .item { 
      background: white; 
      padding: 12px; 
      margin-bottom: 10px; 
      border-radius: 8px; 
      box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
      display: flex;
      flex-direction: column;
    }
    .item-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .item-name { font-weight: bold; font-size: 16px; }
    .quantity-badge {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 6px;
      white-space: nowrap;
    }
    .location-path { 
      color: #666; 
      font-size: 13px; 
      margin: 4px 0; 
      word-break: break-word;
    }
    .item-img-preview {
      max-width: 100%;
      max-height: 80px;
      object-fit: cover;
      border-radius: 4px;
      margin: 6px 0;
    }
    .qr-content { 
      margin-top: 6px; 
      padding: 6px; 
      background: #f0f8ff; 
      border-left: 2px solid #4A90E2; 
      font-size: 14px;
    }
    .item-actions { 
      margin-top: 8px; 
      display: flex; 
      gap: 8px; 
    }
    .item-actions button { 
      flex: 1; 
      padding: 6px; 
      font-size: 13px; 
    }

    #storageWarning { 
      background: #fff8e1; 
      padding: 8px; 
      border-radius: 6px; 
      margin: 10px 0; 
      display: none; 
      color: #e65100; 
      font-size: 14px;
    }

    #customModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    #modalContent {
      background: white;
      padding: 18px;
      border-radius: 12px;
      width: 90%;
      max-width: 300px;
      text-align: center;
    }
    #modalTitle { font-weight: bold; margin-bottom: 10px; }
    #modalInput { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    .modal-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .modal-buttons button { flex: 1; padding: 8px; font-size: 14px; }

    .chart-container {
      position: relative;
      height: 200px;
      margin: 16px 0;
      width: 100%;
    }
    canvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
    }

    #photoUploadArea {
      display: block;
      text-align: center;
      padding: 16px;
      border: 2px dashed #ccc;
      cursor: pointer;
      margin: 12px 0;
      border-radius: 8px;
      background: #fafafa;
      position: relative;
    }
    #photoPreviewInForm {
      max-width: 100%;
      max-height: 100px;
      margin-top: 10px;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>
<body>

<h1>ğŸ  å®¶åº­ç‰©å“ç®¡ç†ä¸€å£æ¸…</h1>

<div class="tab-bar">
  <div class="tab active" data-tab="manage">ğŸ“¦ ç‰©å“ç®¡ç†</div>
  <div class="tab" data-tab="stats">ğŸ“Š ç»Ÿè®¡</div>
</div>

<!-- ç®¡ç†é¢æ¿ -->
<div id="managePanel" class="panel">
  <div id="storageWarning"></div>

  <label for="itemName">ç‰©å“åç§°ï¼ˆå¿…å¡«ï¼‰</label>
  <input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šèºä¸åˆ€ã€åˆ›å¯è´´" />

  <label for="itemQuantity">æ•°é‡ï¼ˆä¸ªï¼‰</label>
  <input 
    type="number" 
    inputmode="numeric"
    id="itemQuantity" 
    min="1" 
    value="1" 
    placeholder="ä¾‹å¦‚ï¼š1ã€5ã€100"
  />

  <label for="itemCategory">åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
  <input type="text" id="itemCategory" placeholder="å¦‚ï¼šå·¥å…·ã€è¯å“ã€æ–‡å…·" list="categoryList" />
  <datalist id="categoryList"></datalist>

  <label for="itemRoom">æ‰€åœ¨æˆ¿é—´ï¼ˆå¿…å¡«ï¼‰</label>
  <select id="itemRoom">
    <option value="">è¯·é€‰æ‹©æˆ¿é—´</option>
  </select>
  <button type="button" id="addRoomBtn" style="margin-top:0;">â• æ–°å¢æˆ¿é—´</button>

  <label for="itemContainer">å®¹å™¨ï¼ˆå¯é€‰ï¼‰</label>
  <input type="text" id="itemContainer" placeholder="å¦‚ï¼šå·¥å…·ç®±ã€è¯ç›’" list="containerList" />
  <datalist id="containerList"></datalist>
  <button type="button" id="addContainerBtn" style="margin-top:0;">â• æ–°å¢å®¹å™¨</button>

  <label for="itemShelf">å±‚/æ ¼ï¼ˆå¯é€‰ï¼‰</label>
  <input type="text" id="itemShelf" placeholder="å¦‚ï¼šä¸Šå±‚ã€ç¬¬ä¸€æ ¼" list="shelfList" />
  <datalist id="shelfList"></datalist>

  <label for="itemLocation">å…·ä½“ä½ç½®æè¿°ï¼ˆå¯é€‰ï¼‰</label>
  <textarea id="itemLocation" placeholder="ä¾‹å¦‚ï¼šåºŠå¤´æŸœç¬¬äºŒæŠ½å±‰" rows="2"></textarea>

  <label for="itemImage" id="photoUploadArea">
    ğŸ“¸ ç‚¹å‡»é€‰æ‹©ç…§ç‰‡æˆ–æ‹ç…§
    <img id="photoPreviewInForm" src="" alt="é¢„è§ˆ" />
  </label>
  <input type="file" id="itemImage" accept="image/*" capture="environment" style="display:none;" />

  <label for="itemQrCode" style="display:block; text-align:center; padding:10px; background:#f0f8ff; border:1px dashed #4A90E2; border-radius:6px; margin:10px 0; cursor:pointer;">
    ğŸ·ï¸ ç‚¹å‡»ä¸Šä¼ äºŒç»´ç å›¾ç‰‡ï¼ˆè‡ªåŠ¨è¯†åˆ«å†…å®¹ï¼‰
  </label>
  <input type="file" id="itemQrCode" accept="image/*" style="display:none;" />

  <input type="hidden" id="editId" value="" />
  <button id="saveBtn">â• æ·»åŠ ç‰©å“</button>

  <hr style="margin:16px 0;" />
  <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ç‰©å“åç§°/ä½ç½®/äºŒç»´ç " />
  <div id="itemsList"></div>
  <p style="text-align:right; margin-top:10px; color:#666; font-size:14px;">
    å…± <span id="totalItems">0</span> é¡¹ | æ€»è®¡ <span id="totalQuantity">0</span> ä¸ª
  </p>

  <div style="margin-top:16px; display:flex; gap:8px;">
    <button id="exportBtn" style="flex:1;">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
    <button id="importBtn" style="flex:1; background:#FF9800;">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
    <button id="clearDataBtn" style="flex:1; background:#f44336;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
  </div>
</div>

<!-- ç»Ÿè®¡é¢æ¿ -->
<div id="statsPanel" class="panel">
  <h3 style="text-align:center; margin:12px 0;">æŒ‰æˆ¿é—´åˆ†å¸ƒ</h3>
  <div class="chart-container"><canvas id="roomChart"></canvas></div>
  
  <h3 style="text-align:center; margin:12px 0;">æŒ‰åˆ†ç±»åˆ†å¸ƒ</h3>
  <div class="chart-container"><canvas id="categoryChart"></canvas></div>
  
  <h3 style="text-align:center; margin:12px 0;">æŒ‰å®¹å™¨åˆ†å¸ƒ</h3>
  <div class="chart-container"><canvas id="containerChart"></canvas></div>
</div>

<!-- è‡ªå®šä¹‰ Modal -->
<div id="customModal">
  <div id="modalContent">
    <div id="modalTitle">è¯·è¾“å…¥åç§°</div>
    <input type="text" id="modalInput" placeholder="ä¾‹å¦‚ï¼šä¹¦æˆ¿" maxlength="30" />
    <div class="modal-buttons">
      <button id="modalCancelBtn">å–æ¶ˆ</button>
      <button id="modalConfirmBtn" style="background:#4CAF50;">ç¡®å®š</button>
    </div>
  </div>
</div>

<canvas id="qrCanvas" style="display:none;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
// === å…¨å±€å˜é‡ ===
let items = [];
let recentRooms = ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];
let recentContainers = ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];
let recentShelves = ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];

let roomChartInstance = null;
let categoryChartInstance = null;
let containerChartInstance = null;

let userSelectedNewImage = false;
let pendingItemImageBase64 = '';

// === å·¥å…·å‡½æ•° ===
function isDataTooLarge(dataToSave, maxSizeBytes = 4_700_000) {
  try {
    const jsonString = JSON.stringify(dataToSave);
    const byteLength = new TextEncoder().encode(jsonString).length;
    return byteLength > maxSizeBytes;
  } catch (e) {
    return true;
  }
}

function compressImage(file, maxWidth = 600, quality = 0.7) {
  return new Promise((resolve) => {
    if (!file.type.startsWith('image/')) {
      resolve(null);
      return;
    }
    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = () => {
      let width = img.width;
      let height = img.height;
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      canvas.toBlob(resolve, 'image/jpeg', quality);
    };
    img.onerror = () => resolve(null);
  });
}

async function decodeQRFromFile(file) {
  return new Promise((resolve) => {
    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = () => {
      const canvas = document.getElementById('qrCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0, img.width, img.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      resolve(code ? code.data : null);
    };
    img.onerror = () => resolve(null);
  });
}

document.addEventListener('DOMContentLoaded', async () => {

  // === åŠ è½½æ•°æ® ===
  function loadDataFromStorage() {
    try {
      const savedItems = localStorage.getItem('homeItems_v5');
      if (savedItems) {
        const data = JSON.parse(savedItems);
        items = Array.isArray(data) ? data : [];
      } else {
        const oldItems = localStorage.getItem('homeItems');
        if (oldItems) {
          items = JSON.parse(oldItems) || [];
          localStorage.setItem('homeItems_v5', JSON.stringify(items));
        }
      }

      const rooms = localStorage.getItem('recentRooms');
      recentRooms = rooms ? JSON.parse(rooms) : ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];

      const containers = localStorage.getItem('recentContainers');
      recentContainers = containers ? JSON.parse(containers) : ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];

      const shelves = localStorage.getItem('recentShelves');
      recentShelves = shelves ? JSON.parse(shelves) : ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];
    } catch (e) {
      console.warn('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼', e);
    }
  }

  // === æ¸²æŸ“ä¸‹æ‹‰é€‰é¡¹ ===
  function renderFormOptions() {
    const itemRoom = document.getElementById('itemRoom');
    const containerList = document.getElementById('containerList');
    const categoryList = document.getElementById('categoryList');
    const shelfList = document.getElementById('shelfList');

    itemRoom.innerHTML = '<option value="">è¯·é€‰æ‹©æˆ¿é—´</option>';
    containerList.innerHTML = '';
    categoryList.innerHTML = '';
    shelfList.innerHTML = '';

    recentRooms.forEach(room => {
      const opt = document.createElement('option');
      opt.value = room;
      opt.textContent = room;
      itemRoom.appendChild(opt);
    });

    recentContainers.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      containerList.appendChild(opt);
    });

    [...new Set(items.map(i => i.category).filter(Boolean))].forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      categoryList.appendChild(opt);
    });

    recentShelves.forEach(shelf => {
      const opt = document.createElement('option');
      opt.value = shelf;
      shelfList.appendChild(opt);
    });
  }

  // === å›¾è¡¨æ¸²æŸ“ ===
  function renderCharts() {
    [roomChartInstance, categoryChartInstance, containerChartInstance].forEach(chart => {
      if (chart) chart.destroy();
    });

    setTimeout(() => {
      // æˆ¿é—´
      const roomMap = {};
      items.forEach(item => {
        roomMap[item.room] = (roomMap[item.room] || 0) + (item.quantity || 1);
      });
      const roomLabels = Object.keys(roomMap);
      const roomData = Object.values(roomMap);
      const roomCtx = document.getElementById('roomChart').getContext('2d');
      roomChartInstance = new Chart(roomCtx, {
        type: 'pie',
        data: {
          labels: roomLabels,
          datasets: [{
            data: roomData,
            backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF'].slice(0, roomLabels.length)
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      // åˆ†ç±»
      const categoryMap = {};
      items.filter(i => i.category).forEach(item => {
        categoryMap[item.category] = (categoryMap[item.category] || 0) + (item.quantity || 1);
      });
      const categoryLabels = Object.keys(categoryMap);
      const categoryData = Object.values(categoryMap);
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      if (categoryLabels.length > 0) {
        categoryChartInstance = new Chart(categoryCtx, {
          type: 'doughnut',
          data: {
            labels: categoryLabels,
            datasets: [{
              data: categoryData,
              backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'].slice(0, categoryLabels.length)
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      } else {
        categoryCtx.clearRect(0, 0, categoryCtx.canvas.width, categoryCtx.canvas.height);
        categoryCtx.font = '14px sans-serif';
        categoryCtx.fillText('æš‚æ— åˆ†ç±»æ•°æ®', categoryCtx.canvas.width / 2 - 50, categoryCtx.canvas.height / 2);
      }

      // å®¹å™¨
      const containerMap = {};
      items.filter(i => i.container).forEach(item => {
        containerMap[item.container] = (containerMap[item.container] || 0) + (item.quantity || 1);
      });
      const containerLabels = Object.keys(containerMap);
      const containerData = Object.values(containerMap);
      const containerCtx = document.getElementById('containerChart').getContext('2d');
      if (containerLabels.length > 0) {
        containerChartInstance = new Chart(containerCtx, {
          type: 'bar',
          data: {
            labels: containerLabels,
            datasets: [{
              label: 'ç‰©å“æ•°é‡',
              data: containerData,
              backgroundColor: '#4A90E2'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
      } else {
        containerCtx.clearRect(0, 0, containerCtx.canvas.width, containerCtx.canvas.height);
        containerCtx.font = '14px sans-serif';
        containerCtx.fillText('æš‚æ— å®¹å™¨æ•°æ®', containerCtx.canvas.width / 2 - 50, containerCtx.canvas.height / 2);
      }
    }, 150);
  }

  // === ä¿å­˜æ•°æ® ===
  function saveData() {
    try {
      const dataToSave = { items, recentRooms, recentContainers, recentShelves };
      if (isDataTooLarge(dataToSave)) {
        alert('âš ï¸ æ•°æ®è¿‡å¤§ï¼ˆè¶…è¿‡ 4.7MBï¼‰ï¼\nè¯·åˆ é™¤éƒ¨åˆ†å¸¦å›¾ç‰©å“åå†ä¿å­˜ã€‚');
        return false;
      }
      localStorage.setItem('homeItems_v5', JSON.stringify(items));
      localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
      localStorage.setItem('recentContainers', JSON.stringify(recentContainers));
      localStorage.setItem('recentShelves', JSON.stringify(recentShelves));
      
      renderFormOptions();
      renderItems();
      updateStorageWarning();
      return true;
    } catch (err) {
      if (err.name === 'QuotaExceededError') {
        alert('âš ï¸ æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ï¼');
      } else {
        alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + (err.message || err));
      }
      return false;
    }
  }

  function updateStorageWarning() {
    const warningEl = document.getElementById('storageWarning');
    if (isDataTooLarge({ items, recentRooms, recentContainers, recentShelves })) {
      warningEl.style.display = 'block';
      warningEl.textContent = 'âš ï¸ æ•°æ®æ¥è¿‘æµè§ˆå™¨å­˜å‚¨ä¸Šé™ï¼ˆ5MBï¼‰ï¼Œå»ºè®®å¯¼å‡ºå¤‡ä»½æˆ–åˆ é™¤å¸¦å›¾ç‰©å“ã€‚';
    } else {
      warningEl.style.display = 'none';
    }
  }

  function getLocationPath(item) {
    let path = item.room;
    if (item.container) path += ` > ${item.container}`;
    if (item.shelf) path += ` > ${item.shelf}`;
    return path;
  }

  function renderItems() {
    const searchInput = document.getElementById('searchInput');
    const itemsList = document.getElementById('itemsList');
    const term = searchInput.value.trim().toLowerCase();
    const filtered = items.filter(item =>
      item.name.toLowerCase().includes(term) ||
      getLocationPath(item).toLowerCase().includes(term) ||
      (item.specific_location && item.specific_location.toLowerCase().includes(term)) ||
      (item.qr_code && item.qr_code.toLowerCase().includes(term))
    );

    itemsList.innerHTML = filtered.length === 0
      ? '<p style="text-align:center;color:#888;font-size:15px;">æš‚æ— ç‰©å“</p>'
      : filtered.map((item) => {
          const qtyDisplay = item.quantity > 1 ? `<span class="quantity-badge">Ã—${item.quantity}</span>` : '';
          let qrDisplay = '';
          if (item.qr_code) {
            const isUrl = /^https?:\/\//.test(item.qr_code);
            qrDisplay = `
              <div class="qr-content">
                <strong>ğŸ”— äºŒç»´ç ï¼š</strong>
                ${isUrl 
                  ? `<a href="${item.qr_code}" target="_blank" rel="noopener" style="color:#1976d2;">${item.qr_code}</a>`
                  : `<span>${item.qr_code}</span>`
                }
              </div>
            `;
          }

          return `
            <div class="item" data-id="${item.id}">
              <div class="item-header">
                <span class="item-name">${item.name}</span>
                ${qtyDisplay}
              </div>
              ${item.category ? `<div><small>ğŸ“‚ ${item.category}</small></div>` : ''}
              <div class="location-path">${getLocationPath(item)}</div>
              ${item.specific_location ? `<div style="font-size:13px;color:#555;">${item.specific_location}</div>` : ''}
              ${item.image ? `<img class="item-img-preview" src="${item.image}" alt="${item.name}">` : ''}
              ${qrDisplay}
              <div class="item-actions">
                <button class="secondary edit-btn">âœï¸ ç¼–è¾‘</button>
                <button class="secondary delete-btn">ğŸ—‘ï¸ åˆ é™¤</button>
              </div>
            </div>
          `;
        }).join('');

    const totalQty = items.reduce((sum, item) => sum + (item.quantity || 1), 0);
    document.getElementById('totalItems').textContent = items.length;
    document.getElementById('totalQuantity').textContent = totalQty;
  }

  // äº‹ä»¶å§”æ‰˜
  document.getElementById('itemsList').addEventListener('click', (e) => {
    if (e.target.classList.contains('edit-btn')) {
      const itemDiv = e.target.closest('.item');
      const id = itemDiv.dataset.id;
      const item = items.find(i => i.id === id);
      if (!item) return;
      
      // âœ… é‡ç½®çŠ¶æ€
      userSelectedNewImage = false;
      pendingItemImageBase64 = '';
      
      // å¡«å……è¡¨å•
      document.getElementById('editId').value = item.id;
      document.getElementById('itemName').value = item.name;
      document.getElementById('itemQuantity').value = item.quantity || 1;
      document.getElementById('itemCategory').value = item.category || '';
      document.getElementById('itemRoom').value = item.room;
      document.getElementById('itemContainer').value = item.container || '';
      document.getElementById('itemShelf').value = item.shelf || '';
      document.getElementById('itemLocation').value = item.specific_location || '';
      
      // âœ… æ˜¾ç¤ºåŸå›¾é¢„è§ˆ
      const previewImg = document.getElementById('photoPreviewInForm');
      if (item.image) {
        previewImg.src = item.image;
        previewImg.style.display = 'block';
      } else {
        previewImg.style.display = 'none';
      }

      document.getElementById('saveBtn').textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
      
      // âœ… å…³é”®ï¼šé‡æ–°æ¸²æŸ“ä¸‹æ‹‰é€‰é¡¹ï¼ˆä¿®å¤å®¹å™¨åˆ—è¡¨ä¸æ˜¾ç¤ºï¼‰
      renderFormOptions();
      
      window.scrollTo(0, 0);
    } else if (e.target.classList.contains('delete-btn')) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç‰©å“ï¼Ÿ')) return;
      const itemDiv = e.target.closest('.item');
      const id = itemDiv.dataset.id;
      items = items.filter(item => item.id !== id);
      saveData();
    }
  });

  let currentModalType = '';
  function showAddModal(type) {
    currentModalType = type;
    document.getElementById('modalTitle').textContent = type === 'room' ? 'æ–°å¢æˆ¿é—´' : 'æ–°å¢å®¹å™¨';
    document.getElementById('modalInput').value = '';
    document.getElementById('customModal').style.display = 'flex';
    document.getElementById('modalInput').focus();
  }

  function handleModalCancel() {
    document.getElementById('customModal').style.display = 'none';
    currentModalType = '';
  }

  function handleModalConfirm() {
    const value = document.getElementById('modalInput').value.trim();
    if (!value) {
      alert('åç§°ä¸èƒ½ä¸ºç©º');
      return;
    }
    let changed = false;
    if (currentModalType === 'room') {
      if (!recentRooms.includes(value)) {
        recentRooms.unshift(value);
        recentRooms = recentRooms.slice(0, 20);
        changed = true;
      }
    } else if (currentModalType === 'container') {
      if (!recentContainers.includes(value)) {
        recentContainers.unshift(value);
        recentContainers = recentContainers.slice(0, 20);
        changed = true;
      }
    }
    if (changed && saveData()) {}
    handleModalCancel();
  }

  // âœ… ä¿®å¤ï¼šå›¾ç‰‡é€‰æ‹©å¤„ç†
  document.getElementById('itemImage').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    const previewImg = document.getElementById('photoPreviewInForm');
    if (file) {
      userSelectedNewImage = true;
      const compressedBlob = await compressImage(file);
      if (compressedBlob) {
        const reader = new FileReader();
        reader.onload = () => {
          pendingItemImageBase64 = reader.result;
          previewImg.src = reader.result;
          previewImg.style.display = 'block';
        };
        reader.readAsDataURL(compressedBlob);
      } else {
        alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
        userSelectedNewImage = false;
        pendingItemImageBase64 = '';
        previewImg.style.display = 'none';
      }
    } else {
      // ç”¨æˆ·å–æ¶ˆé€‰æ‹©
      userSelectedNewImage = false;
      pendingItemImageBase64 = '';
      // ä¸éšè—åŸå›¾ï¼ˆå¦‚æœæ˜¯ç¼–è¾‘çŠ¶æ€ï¼‰
      const editId = document.getElementById('editId').value;
      if (editId) {
        const item = items.find(i => i.id === editId);
        if (item && item.image) {
          previewImg.src = item.image;
          previewImg.style.display = 'block';
        } else {
          previewImg.style.display = 'none';
        }
      } else {
        previewImg.style.display = 'none';
      }
    }
  });

  // âœ… å½»åº•ä¿®å¤ä¿å­˜é€»è¾‘
  async function handleSave() {
    const name = document.getElementById('itemName').value.trim();
    const room = document.getElementById('itemRoom').value.trim();
    if (!name || !room) {
      alert('ç‰©å“åç§°å’Œæˆ¿é—´ä¸ºå¿…å¡«é¡¹ï¼');
      return;
    }

    const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
    const category = document.getElementById('itemCategory').value.trim();
    const container = document.getElementById('itemContainer').value.trim();
    const shelf = document.getElementById('itemShelf').value.trim();
    const location = document.getElementById('itemLocation').value.trim();

    const editId = document.getElementById('editId').value;
    const existingItem = editId ? items.find(i => i.id === editId) : null;

    let imageToSave = '';
    if (userSelectedNewImage && pendingItemImageBase64) {
      imageToSave = pendingItemImageBase64;
    } else if (existingItem) {
      imageToSave = existingItem.image || '';
    }

    let qrContent = '';
    const qrFile = document.getElementById('itemQrCode').files[0];
    if (qrFile) {
      qrContent = await decodeQRFromFile(qrFile);
      if (qrContent === null) {
        alert('æœªèƒ½è¯†åˆ«äºŒç»´ç ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”åŒ…å«æœ‰æ•ˆäºŒç»´ç ã€‚\nè¯·é‡æ–°ä¸Šä¼ æˆ–å–æ¶ˆäºŒç»´ç ä¸Šä¼ ã€‚');
        return;
      }
    } else if (existingItem) {
      qrContent = existingItem.qr_code || '';
    }

    const newItem = {
      id: editId || (Date.now().toString(36) + Math.random().toString(36).substr(2, 5)),
      name, quantity, category, room, container, shelf,
      specific_location: location,
      image: imageToSave,
      qr_code: qrContent
    };

    if (editId) {
      const index = items.findIndex(i => i.id === editId);
      if (index >= 0) items[index] = newItem;
    } else {
      items.push(newItem);
    }

    if (saveData()) {
      resetForm();
    }
  }

  function resetForm() {
    document.getElementById('editId').value = '';
    document.getElementById('itemName').value = '';
    document.getElementById('itemQuantity').value = '1';
    document.getElementById('itemCategory').value = '';
    document.getElementById('itemRoom').value = '';
    document.getElementById('itemContainer').value = '';
    document.getElementById('itemShelf').value = '';
    document.getElementById('itemLocation').value = '';
    document.getElementById('itemImage').value = '';
    document.getElementById('itemQrCode').value = '';
    document.getElementById('saveBtn').textContent = 'â• æ·»åŠ ç‰©å“';
    
    userSelectedNewImage = false;
    pendingItemImageBase64 = '';
    document.getElementById('photoPreviewInForm').style.display = 'none';
  }

  function exportData() {
    const dataStr = JSON.stringify({ items, recentRooms, recentContainers, recentShelves }, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'å®¶åº­ç‰©å“æ•°æ®.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data.items)) throw new Error('æ ¼å¼é”™è¯¯');
        items = data.items;
        recentRooms = Array.isArray(data.recentRooms) ? data.recentRooms : recentRooms;
        recentContainers = Array.isArray(data.recentContainers) ? data.recentContainers : recentContainers;
        recentShelves = Array.isArray(data.recentShelves) ? data.recentShelves : recentShelves;
        if (saveData()) {
          alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼');
        }
      } catch (err) {
        alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + (err.message || 'æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®'));
      }
    };
    input.click();
  }

  function clearAllData() {
    if (confirm('âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
      items = [];
      recentRooms = ["ä¸»å§","æ¬¡å§","å¨æˆ¿","å®¢å…","å«ç”Ÿé—´","é˜³å°","è½¦åº“"];
      recentContainers = ["è¡£æŸœ","æŠ½å±‰","å·¥å…·ç®±","ä¹¦æ¶","å†°ç®±"];
      recentShelves = ["ä¸Šå±‚","ä¸­å±‚","ä¸‹å±‚","ç¬¬ä¸€æ ¼","ç¬¬äºŒæ ¼"];
      saveData();
      resetForm();
    }
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
    
    const targetTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
    const targetPanel = document.getElementById(`${tabName}Panel`);
    
    targetTab.classList.add('active');
    targetPanel.style.display = 'block';

    if (tabName === 'stats') {
      setTimeout(() => renderCharts(), 150);
    }
  }

  // === äº‹ä»¶ç»‘å®š ===
  document.getElementById('addRoomBtn').addEventListener('click', () => showAddModal('room'));
  document.getElementById('addContainerBtn').addEventListener('click', () => showAddModal('container'));
  document.getElementById('modalCancelBtn').addEventListener('click', handleModalCancel);
  document.getElementById('modalConfirmBtn').addEventListener('click', handleModalConfirm);
  document.getElementById('saveBtn').addEventListener('click', handleSave);
  document.getElementById('exportBtn').addEventListener('click', exportData);
  document.getElementById('importBtn').addEventListener('click', importData);
  document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
  document.getElementById('searchInput').addEventListener('input', renderItems);

  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      const tabName = e.currentTarget.dataset.tab;
      switchTab(tabName);
    });
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('customModal').style.display === 'flex') {
      handleModalCancel();
    }
  });

  document.getElementById('customModal').addEventListener('click', (e) => {
    if (e.target.id === 'customModal') handleModalCancel();
  });

  document.getElementById('photoUploadArea').addEventListener('click', () => {
    document.getElementById('itemImage').click();
  });

  // åˆå§‹åŒ–
  loadDataFromStorage();
  renderFormOptions();
  renderItems();
  updateStorageWarning();

});
</script>

</body>
</html>

